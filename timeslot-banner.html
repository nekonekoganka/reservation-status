<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„æ™‚é–“æ ãƒãƒŠãƒ¼</title>
    <style>
        /* ãƒãƒŠãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .reservation-banner {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        /* ãƒ›ãƒãƒ¼æ™‚ã®åŠ¹æœ */
        .reservation-banner:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* äºˆç´„å¯èƒ½ã®æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .reservation-banner.available {
            background: #0056B3;
            color: white;
            border: 3px solid #004085;
        }

        /* äºˆç´„ä¸å¯ã®æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .reservation-banner.unavailable {
            background: #DC3545;
            color: white;
            border: 3px solid #bd2130;
        }

        /* èª­ã¿è¾¼ã¿ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .reservation-banner.loading {
            background: #c8d0e7;
            color: #333;
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .reservation-banner h2 {
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: bold;
        }

        /* æ™‚é–“æ ã‚³ãƒ³ãƒ†ãƒŠ */
        .reservation-banner .timeslots {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        /* å€‹åˆ¥ã®æ™‚é–“æ ãƒ”ãƒ« */
        .reservation-banner.available .timeslot-pill {
            background: white;
            color: #CC6600;
            border: 3px solid #CC6600;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 22px;
            font-weight: bold;
        }

        /* ã€Œã»ã‹ã€ã€Œã®ã¿ã€è¡¨ç¤º */
        .reservation-banner.available .timeslot-more {
            color: white;
            font-size: 22px;
            font-weight: bold;
            padding: 8px 6px;
        }

        /* 1ã€œ2æ ã®æ™‚ã®ä¸­å¤®æƒãˆç”¨ã‚¹ãƒšãƒ¼ã‚µãƒ¼ï¼ˆé€æ˜ã§ã€Œã®ã¿ã€ã¨åŒã˜å¹…ï¼‰ */
        .reservation-banner.available .timeslot-spacer {
            visibility: hidden;
            font-size: 22px;
            font-weight: bold;
            padding: 8px 6px;
        }

        /* ã‚µãƒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .reservation-banner p {
            margin: 5px 0;
            font-size: 18px;
            opacity: 0.9;
        }

        /* è£œè¶³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .reservation-banner .note {
            margin: 10px 0;
            font-size: 14px;
            opacity: 0.85;
        }

        /* æ›´æ–°æ™‚åˆ» */
        .reservation-banner .update-time {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.8;
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .reservation-banner.error {
            background: #f5f5f5;
            color: #666;
            border: 2px dashed #ccc;
        }

        /* å¹´æœ«å¹´å§‹ä¼‘æ¥­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .reservation-banner.newyear {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            color: white;
            border: 3px solid #8B0000;
        }

        .reservation-banner.newyear h2 {
            font-size: 24px;
        }

        .reservation-banner.newyear .holiday-period {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px 15px;
            margin: 15px 0;
            font-size: 20px;
            font-weight: bold;
        }

        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 600px) {
            .reservation-banner {
                margin: 5px;
                padding: 15px;
                max-width: none;
                width: calc(100% - 10px);
                box-sizing: border-box;
            }

            .reservation-banner h2 {
                font-size: 22px;
            }

            .reservation-banner.available .timeslot-pill {
                font-size: 18px;
                padding: 6px 10px;
            }

            .reservation-banner.available .timeslot-more {
                font-size: 18px;
            }

            .reservation-banner.available .timeslot-spacer {
                font-size: 18px;
            }

            .reservation-banner p {
                font-size: 16px;
            }

            .reservation-banner .update-time {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>

<!-- äºˆç´„æ™‚é–“æ ãƒãƒŠãƒ¼ -->
<div id="reservationBanner" class="reservation-banner loading">
    <h2>èª­ã¿è¾¼ã¿ä¸­...</h2>
    <p>äºˆç´„æ™‚é–“æ ã‚’ç¢ºèªã—ã¦ã„ã¾ã™</p>
</div>

<script>
    // Cloud Storageã®URL
    const API_URL = 'https://storage.googleapis.com/reservation-timeslots-fujiminohikari/timeslots.json';

    /**
     * å¹´æœ«å¹´å§‹ä¼‘æ¥­æœŸé–“ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
     * 12/30 18:30 ã€œ 1/3 18:29 ã®é–“ã¯true
     */
    function isNewYearPeriod() {
        const now = new Date();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        const hour = now.getHours();
        const minute = now.getMinutes();
        const timeInMinutes = hour * 60 + minute;

        // 12/30 18:30ä»¥é™
        if (month === 12 && day === 30 && timeInMinutes >= 18 * 60 + 30) return true;

        // 12/31ï¼ˆçµ‚æ—¥ï¼‰
        if (month === 12 && day === 31) return true;

        // 1/1ã€œ1/2ï¼ˆçµ‚æ—¥ï¼‰
        if (month === 1 && (day === 1 || day === 2)) return true;

        // 1/3 00:00ã€œ18:29
        if (month === 1 && day === 3 && timeInMinutes < 18 * 60 + 30) return true;

        return false;
    }

    /**
     * æ—¥ä»˜ã‚’ M/D å½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
     */
    function formatDateMD(date) {
        return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    /**
     * æ—¥ä»˜ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆæœˆ/æ—¥ä»˜ãï¼‰
     */
    function calculateDayText(updateTime) {
        const now = new Date(updateTime);
        const dayOfWeek = now.getDay();
        const hour = now.getHours();
        const minute = now.getMinutes();
        const isAfter1830 = (hour > 18) || (hour === 18 && minute >= 30);
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

        // ğŸ“… æ—¥ä»˜åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
        // ç«æ›œ18:30ä»¥é™ â†’ æœ¨æ›œæ—¥
        // æ°´æ›œæ—¥ï¼ˆçµ‚æ—¥ï¼‰ â†’ æœ¨æ›œæ—¥
        // æœˆæœ«18:30ä»¥é™ â†’ æ¬¡ã®è¨ºç™‚æ—¥
        // ãã®ä»–18:30ä»¥é™ â†’ æ˜æ—¥
        // 18:30ã‚ˆã‚Šå‰ â†’ æœ¬æ—¥
        if (dayOfWeek === 3) {
            // æ°´æ›œæ—¥ â†’ æœ¨æ›œæ—¥ã®æ—¥ä»˜ã‚’è¨ˆç®—
            const thursday = new Date(now);
            thursday.setDate(thursday.getDate() + 1);
            return `æœ¨æ›œï¼ˆ${formatDateMD(thursday)}ï¼‰`;
        }

        if (isAfter1830) {
            if (now.getDate() === lastDayOfMonth) {
                return 'æ¬¡ã®è¨ºç™‚æ—¥';
            }

            if (dayOfWeek === 2) {
                // ç«æ›œ18:30ä»¥é™ â†’ æœ¨æ›œæ—¥ã®æ—¥ä»˜ã‚’è¨ˆç®—
                const thursday = new Date(now);
                thursday.setDate(thursday.getDate() + 2);
                return `æœ¨æ›œï¼ˆ${formatDateMD(thursday)}ï¼‰`;
            }

            // æ˜æ—¥ã®æ—¥ä»˜ã‚’å–å¾—
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            return `æ˜æ—¥ï¼ˆ${formatDateMD(tomorrow)}ï¼‰`;
        }

        return `æœ¬æ—¥ï¼ˆ${formatDateMD(now)}ï¼‰`;
    }

    /**
     * äºˆç´„æ™‚é–“æ ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
     */
    async function updateTimeslots() {
        const banner = document.getElementById('reservationBanner');

        // å¹´æœ«å¹´å§‹ãƒã‚§ãƒƒã‚¯ï¼ˆ12/30 18:30 ã€œ 1/3 18:29ï¼‰
        if (isNewYearPeriod()) {
            banner.className = 'reservation-banner newyear';
            banner.innerHTML = `
                <h2>ğŸ å¹´æœ«å¹´å§‹ä¼‘æ¥­ã®ãŠçŸ¥ã‚‰ã›</h2>
                <div class="holiday-period">12æœˆ31æ—¥ã€œ1æœˆ3æ—¥</div>
                <p>å¹´æœ«å¹´å§‹ã¯ä¼‘è¨ºã„ãŸã—ã¾ã™</p>
                <p>1æœˆ4æ—¥ã‚ˆã‚Šé€šå¸¸è¨ºç™‚ã„ãŸã—ã¾ã™</p>
                <p style="margin-top: 15px; font-size: 14px;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦äºˆç´„ãƒšãƒ¼ã‚¸ã¸</p>
            `;
            return;
        }

        try {
            // JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const response = await fetch(API_URL + '?t=' + Date.now()); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // æ—¥ä»˜ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨ˆç®—
            const dayText = calculateDayText(data.updatedAt);

            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const formattedTime = formatTimestamp(data.updatedAt);

            // æ™‚é–“æ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const hasSlots = data.slots && data.slots.length > 0;

            if (hasSlots) {
                // æ™‚é–“æ ã‚’å€‹åˆ¥ã®ãƒ”ãƒ«ã¨ã—ã¦è¡¨ç¤ºï¼ˆæœ€å¤§3ã¤ã€ãã‚Œä»¥ä¸Šã¯ã€Œâ€¦ã€ï¼‰
                const displaySlots = data.slots.slice(0, 3);
                const pillsHtml = displaySlots.map(slot =>
                    `<span class="timeslot-pill">${slot}</span>`
                ).join('');

                // 1ã€œ2æ : å·¦ã«ã‚¹ãƒšãƒ¼ã‚µãƒ¼ + æ™‚é–“æ  + å³ã«ã€Œã®ã¿ã€ã§ä¸­å¤®æƒãˆ
                // 3æ : æ™‚é–“æ  + ã€Œã®ã¿ã€
                // 4æ ä»¥ä¸Š: æ™‚é–“æ  + ã€Œã»ã‹ã€
                let timeslotsHtml;
                if (data.slots.length <= 2) {
                    timeslotsHtml = `<span class="timeslot-spacer">ã®ã¿</span>${pillsHtml}<span class="timeslot-more">ã®ã¿</span>`;
                } else if (data.slots.length === 3) {
                    timeslotsHtml = `${pillsHtml}<span class="timeslot-more">ã®ã¿</span>`;
                } else {
                    timeslotsHtml = `${pillsHtml}<span class="timeslot-more">ã»ã‹</span>`;
                }

                banner.className = 'reservation-banner available';
                banner.innerHTML = `
                    <h2>âœ… ${dayText}</h2>
                    <div class="timeslots">${timeslotsHtml}</div>
                    <p><strong>ã« ç©ºããŒã”ã–ã„ã¾ã™</strong></p>
                    <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦äºˆç´„ãƒšãƒ¼ã‚¸ã¸</p>
                    <div class="update-time">${formattedTime}</div>
                `;
            } else {
                // æº€æ ã¾ãŸã¯ä¼‘è¨ºæ—¥ã®å ´åˆ
                let message = 'æº€æ ';

                if (data.status === 'closed') {
                    message = 'ä¼‘è¨ºæ—¥';
                }

                banner.className = 'reservation-banner unavailable';
                banner.innerHTML = `
                    <h2>ğŸ˜” ${dayText}ã¯${message}ã§ã™</h2>
                    <p>èª ã«æã‚Œå…¥ã‚Šã¾ã™ãŒã€æ¬¡ã®è¨ºç™‚æ—¥ä»¥é™ã§ ã”äºˆç´„ãã ã•ã„</p>
                    <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ äºˆç´„ãƒšãƒ¼ã‚¸ã¸</p>
                    <div class="update-time">${formattedTime}</div>
                `;
            }

        } catch (error) {
            console.error('ã‚¨ãƒ©ãƒ¼:', error);
            displayError();
        }
    }

    /**
     * ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã€Œæ›´æ–°ï¼šYYYY/MM/DD HH:MMã€å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
     */
    function formatTimestamp(isoString) {
        const date = new Date(isoString);

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');

        return `æ›´æ–°ï¼š${year}/${month}/${day} ${hours}:${minutes}`;
    }

    /**
     * ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã™ã‚‹é–¢æ•°
     */
    function displayError() {
        const banner = document.getElementById('reservationBanner');
        banner.className = 'reservation-banner error';
        banner.innerHTML = `
            <h2>âš ï¸ æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“</h2>
            <p>ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„</p>
        `;
    }

    // ãƒãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç†
    document.getElementById('reservationBanner').addEventListener('click', function() {
        window.open('https://ckreserve.com/clinic/fujiminohikari-ganka', '_blank');
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    updateTimeslots();

    // 1åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆ60000ãƒŸãƒªç§’ = 1åˆ†ï¼‰
    setInterval(updateTimeslots, 60000);
</script>

</body>
</html>
