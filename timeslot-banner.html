<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„æ™‚é–“æ ãƒãƒŠãƒ¼</title>
    <style>
        /* ãƒãƒŠãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .reservation-banner {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        /* ãƒ›ãƒãƒ¼æ™‚ã®åŠ¹æœ */
        .reservation-banner:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* äºˆç´„å¯èƒ½ã®æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .reservation-banner.available {
            background: #0056B3;
            color: white;
            border: 3px solid #004085;
        }

        /* äºˆç´„ä¸å¯ã®æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .reservation-banner.unavailable {
            background: #DC3545;
            color: white;
            border: 3px solid #bd2130;
        }

        /* èª­ã¿è¾¼ã¿ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .reservation-banner.loading {
            background: #c8d0e7;
            color: #333;
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .reservation-banner h2 {
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: bold;
        }

        /* æ™‚é–“æ è¡¨ç¤º */
        .reservation-banner .timeslots {
            margin: 10px 0;
            font-size: 24px;
            font-weight: bold;
            line-height: 1.4;
        }

        /* ã‚µãƒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .reservation-banner p {
            margin: 5px 0;
            font-size: 18px;
            opacity: 0.9;
        }

        /* è£œè¶³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .reservation-banner .note {
            margin: 10px 0;
            font-size: 14px;
            opacity: 0.85;
        }

        /* æ›´æ–°æ™‚åˆ» */
        .reservation-banner .update-time {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.8;
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .reservation-banner.error {
            background: #f5f5f5;
            color: #666;
            border: 2px dashed #ccc;
        }

        /* ã‚¹ãƒãƒ›å¯¾å¿œ */
        @media (max-width: 600px) {
            .reservation-banner {
                margin: 10px;
                padding: 15px;
            }

            .reservation-banner h2 {
                font-size: 22px;
            }

            .reservation-banner .timeslots {
                font-size: 20px;
            }

            .reservation-banner p {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>

<!-- äºˆç´„æ™‚é–“æ ãƒãƒŠãƒ¼ -->
<div id="reservationBanner" class="reservation-banner loading">
    <h2>èª­ã¿è¾¼ã¿ä¸­...</h2>
    <p>äºˆç´„æ™‚é–“æ ã‚’ç¢ºèªã—ã¦ã„ã¾ã™</p>
</div>

<script>
    // Cloud Storageã®URL
    const API_URL = 'https://storage.googleapis.com/reservation-timeslots-fujiminohikari/timeslots.json';

    /**
     * æ—¥ä»˜ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
     */
    function calculateDayText(updateTime) {
        const now = new Date(updateTime);
        const dayOfWeek = now.getDay();
        const hour = now.getHours();
        const minute = now.getMinutes();
        const isAfter1830 = (hour > 18) || (hour === 18 && minute >= 30);
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

        // ğŸ“… æ—¥ä»˜åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
        // ç«æ›œ18:30ä»¥é™ â†’ æœ¨æ›œæ—¥
        // æ°´æ›œæ—¥ï¼ˆçµ‚æ—¥ï¼‰ â†’ æœ¨æ›œæ—¥
        // æœˆæœ«18:30ä»¥é™ â†’ æ¬¡ã®è¨ºç™‚æ—¥
        // ãã®ä»–18:30ä»¥é™ â†’ æ˜æ—¥
        // 18:30ã‚ˆã‚Šå‰ â†’ æœ¬æ—¥
        if (dayOfWeek === 3) {
            return 'æœ¨æ›œ';
        }

        if (isAfter1830) {
            if (now.getDate() === lastDayOfMonth) {
                return 'æ¬¡ã®è¨ºç™‚æ—¥';
            }

            if (dayOfWeek === 2) {
                return 'æœ¨æ›œ';
            }

            return 'æ˜æ—¥';
        }

        return 'æœ¬æ—¥';
    }

    /**
     * äºˆç´„æ™‚é–“æ ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
     */
    async function updateTimeslots() {
        const banner = document.getElementById('reservationBanner');

        try {
            // JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const response = await fetch(API_URL + '?t=' + Date.now()); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // æ—¥ä»˜ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨ˆç®—
            const dayText = calculateDayText(data.updatedAt);

            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const formattedTime = formatTimestamp(data.updatedAt);

            // æ™‚é–“æ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const hasSlots = data.slots && data.slots.length > 0;

            if (hasSlots) {
                // æ™‚é–“æ ã‚’ã€Œãƒ»ã€ã§åŒºåˆ‡ã£ã¦è¡¨ç¤ºï¼ˆæœ€å¤§3ã¤ã€ãã‚Œä»¥ä¸Šã®å ´åˆã¯ã€Œâ€¦ã€ã‚’è¿½åŠ ï¼‰
                let timeslotsText;
                if (data.slots.length > 3) {
                    timeslotsText = data.slots.slice(0, 3).join('ãƒ»') + 'â€¦';
                } else {
                    timeslotsText = data.slots.join('ãƒ»');
                }

                banner.className = 'reservation-banner available';
                banner.innerHTML = `
                    <h2>âœ… ${dayText}ã®äºˆç´„</h2>
                    <div class="timeslots">${timeslotsText}</div>
                    <p>ã« ç©ºããŒã”ã–ã„ã¾ã™</p>
                    <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦äºˆç´„ãƒšãƒ¼ã‚¸ã¸</p>
                    <div class="update-time">${formattedTime}</div>
                `;
            } else {
                // æº€æ ã¾ãŸã¯ä¼‘è¨ºæ—¥ã®å ´åˆ
                let message = 'æº€æ ';

                if (data.status === 'closed') {
                    message = 'ä¼‘è¨ºæ—¥';
                }

                banner.className = 'reservation-banner unavailable';
                banner.innerHTML = `
                    <h2>ğŸ˜” ${dayText}ã®äºˆç´„ã¯ ${message}ã§ã™</h2>
                    <p>èª ã«æã‚Œå…¥ã‚Šã¾ã™ãŒã€æ¬¡ã®è¨ºç™‚æ—¥ä»¥é™ã§ ã”äºˆç´„ãã ã•ã„</p>
                    <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ äºˆç´„ãƒšãƒ¼ã‚¸ã¸</p>
                    <div class="update-time">${formattedTime}</div>
                `;
            }

        } catch (error) {
            console.error('ã‚¨ãƒ©ãƒ¼:', error);
            displayError();
        }
    }

    /**
     * ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã€Œæ›´æ–°ï¼šYYYY/MM/DD HH:MMã€å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
     */
    function formatTimestamp(isoString) {
        const date = new Date(isoString);

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');

        return `æ›´æ–°ï¼š${year}/${month}/${day} ${hours}:${minutes}`;
    }

    /**
     * ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã™ã‚‹é–¢æ•°
     */
    function displayError() {
        const banner = document.getElementById('reservationBanner');
        banner.className = 'reservation-banner error';
        banner.innerHTML = `
            <h2>âš ï¸ æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“</h2>
            <p>ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„</p>
        `;
    }

    // ãƒãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç†
    document.getElementById('reservationBanner').addEventListener('click', function() {
        window.open('https://ckreserve.com/clinic/fujiminohikari-ganka', '_blank');
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    updateTimeslots();

    // 1åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆ60000ãƒŸãƒªç§’ = 1åˆ†ï¼‰
    setInterval(updateTimeslots, 60000);
</script>

</body>
</html>
