<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„ç©ºãæ™‚é–“ - ãµã˜ã¿é‡ã²ã‹ã‚Šçœ¼ç§‘</title>
    <style>
        /* å…¨ç”»é¢è¡¨ç¤ºç”¨ã®ãƒªã‚»ãƒƒãƒˆ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            overflow: hidden;
        }

        .display-area {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .display-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 80px;
            text-align: center;
            color: white;
            transition: background-color 0.5s ease;
        }

        /* äºˆç´„å¯èƒ½ã®æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ¿ƒã„é»„ç·‘è‰²ï¼‰ */
        .display-container.available {
            background: #27ae60;
        }

        /* äºˆç´„ä¸å¯ã®æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆèµ¤è‰²ï¼‰ */
        .display-container.unavailable {
            background: #dc3545;
        }

        /* èª­ã¿è¾¼ã¿ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .display-container.loading {
            background: #6C757D;
        }

        /* ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .display-container.error {
            background: linear-gradient(135deg, #868E96 0%, #6C757D 100%);
        }

        :root {
            --pulse-duration: 3s;
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³ */
        .icon {
            font-size: clamp(144px, 12vw, 200px);
            margin-bottom: 95px;
            margin-top: 80px;
            line-height: 1;
            animation: pulse var(--pulse-duration) ease-in-out infinite;
            text-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.15);
            }
            100% {
                transform: scale(1);
            }
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ™‚é–“æ è¡¨ç¤ºï¼‰ */
        .main-message {
            font-size: clamp(60px, 6vw, 120px);
            font-weight: 900;
            margin-bottom: 20px;
            line-height: 1.2;
            text-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            animation: fadeIn 1s ease-in;
        }

        /* æ™‚é–“æ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .timeslots {
            font-size: clamp(70px, 7vw, 140px);
            font-weight: 900;
            margin-bottom: 20px;
            line-height: 1.3;
            text-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.02em;
        }

        /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ã‚µãƒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .sub-message {
            font-size: clamp(41px, 4.1vw, 56px);
            margin-bottom: 5px;
            line-height: 1.6;
            opacity: 0.95;
            text-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        /* QRã‚³ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .qr-message {
            font-size: clamp(46px, 4.6vw, 64px);
            font-weight: 400;
            margin-top: 0;
            margin-bottom: 60px;
            opacity: 0.95;
            text-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        /* æ›´æ–°æ™‚åˆ» */
        .update-time {
            font-size: clamp(30px, 3vw, 40px);
            opacity: 0.85;
            margin-top: 0;
            text-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        .error-message {
            font-size: clamp(36px, 4vw, 72px);
            margin-top: 40px;
            text-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        /* æ˜¼ä¼‘ã¿ãƒãƒŠãƒ¼ãƒ»å–¶æ¥­æ™‚é–“å‰ãƒãƒŠãƒ¼ */
        .lunch-break-banner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: #ffc107;
            color: #212529;
            font-size: clamp(16px, 3.6vw, 32px);
            font-weight: bold;
            text-align: center;
            padding: 0 20px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }

        .lunch-break-banner.show {
            display: flex;
        }
    </style>
</head>
<body>
<div class="display-area">
    <!-- å–¶æ¥­æ™‚é–“å‰ãƒãƒŠãƒ¼ -->
    <div id="openingSoonBanner" class="lunch-break-banner">ğŸ• 10æ™‚ã«çª“å£ãŒé–‹ãã¾ã™ã€€ãŠå¾…ã¡ä¸‹ã•ã„</div>

    <!-- æ˜¼ä¼‘ã¿ãƒãƒŠãƒ¼ -->
    <div id="lunchBreakBanner" class="lunch-break-banner">ğŸ• æ˜¼ä¼‘ã¿ä¸­ã€€åˆå¾Œï¼“æ™‚ã‚ˆã‚Šçª“å£ãŒé–‹ãã¾ã™</div>

    <div id="displayContainer" class="display-container loading">
        <div class="icon">â³</div>
        <div class="main-message">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div class="sub-message">äºˆç´„æ™‚é–“æ ã‚’ç¢ºèªã—ã¦ã„ã¾ã™</div>
    </div>
</div>

<script>
    // Cloud Runã®URLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«è¨­å®šï¼‰
    const API_URL = 'https://reservation-timeslot-checker-XXXXX-an.a.run.app/timeslots.json';

    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆï¼‰
    // const API_URL = 'http://localhost:8080/timeslots.json';

    /**
     * å–¶æ¥­æ™‚é–“å‰åˆ¤å®šé–¢æ•°ï¼ˆ8:00-10:00ã€å–¶æ¥­æ—¥ã®ã¿ï¼‰
     */
    function isOpeningSoon() {
        const now = new Date();
        const dayOfWeek = now.getDay(); // 0=æ—¥, 1=æœˆ, 2=ç«, 3=æ°´...
        const hour = now.getHours();

        // æ°´æ›œæ—¥ï¼ˆä¼‘è¨ºæ—¥ï¼‰ã¯è¡¨ç¤ºã—ãªã„
        if (dayOfWeek === 3) {
            return false;
        }

        // 8:00-9:59ã®é–“
        return hour >= 8 && hour < 10;
    }

    /**
     * æ˜¼ä¼‘ã¿åˆ¤å®šé–¢æ•°ï¼ˆ13:30-15:00ã€å–¶æ¥­æ—¥ã®ã¿ï¼‰
     */
    function isLunchBreak() {
        const now = new Date();
        const dayOfWeek = now.getDay();
        const hour = now.getHours();
        const minute = now.getMinutes();

        // æ°´æ›œæ—¥ï¼ˆä¼‘è¨ºæ—¥ï¼‰ã¯è¡¨ç¤ºã—ãªã„
        if (dayOfWeek === 3) {
            return false;
        }

        // 13:30-15:00ã®é–“
        return (hour === 13 && minute >= 30) || (hour === 14);
    }

    /**
     * ãƒãƒŠãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
     */
    function updateBanners() {
        const openingSoonBanner = document.getElementById('openingSoonBanner');
        const lunchBreakBanner = document.getElementById('lunchBreakBanner');

        // å–¶æ¥­æ™‚é–“å‰ãƒãƒŠãƒ¼
        if (isOpeningSoon()) {
            openingSoonBanner.classList.add('show');
        } else {
            openingSoonBanner.classList.remove('show');
        }

        // æ˜¼ä¼‘ã¿ãƒãƒŠãƒ¼
        if (isLunchBreak()) {
            lunchBreakBanner.classList.add('show');
        } else {
            lunchBreakBanner.classList.remove('show');
        }
    }

    /**
     * ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã€Œæ›´æ–°ï¼šYYYY/MM/DD HH:MMã€å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
     */
    function formatTimestamp(isoString) {
        const date = new Date(isoString);

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');

        return `æ›´æ–°ï¼š${year}/${month}/${day} ${hours}:${minutes}`;
    }

    /**
     * SVGãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã‚’ç”Ÿæˆ
     */
    function generateFaviconSVG(isAvailable) {
        const icon = isAvailable ? 'ğŸ•' : 'âœ•';
        const color = isAvailable ? '#27ae60' : '#dc3545';

        return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
            <rect width="32" height="32" fill="${color}"/>
            <text x="16" y="16" font-size="20" text-anchor="middle" dominant-baseline="central" fill="white"
                font-family="Arial, sans-serif" font-weight="bold">${icon}</text>
        </svg>`;
    }

    /**
     * ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã‚’æ›´æ–°
     */
    function updateFavicon(isAvailable) {
        const svg = generateFaviconSVG(isAvailable);
        const base64 = btoa(unescape(encodeURIComponent(svg)));
        const faviconUrl = `data:image/svg+xml;base64,${base64}`;

        let link = document.querySelector('link[rel="icon"]');
        if (!link) {
            link = document.createElement('link');
            link.rel = 'icon';
            link.type = 'image/svg+xml';
            document.head.appendChild(link);
        }

        link.href = faviconUrl;
    }

    /**
     * äºˆç´„æ™‚é–“æ ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
     */
    async function updateTimeslots() {
        const container = document.getElementById('displayContainer');

        try {
            // JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const response = await fetch(API_URL);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // ãƒãƒŠãƒ¼ã‚’æ›´æ–°
            updateBanners();

            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const formattedTime = formatTimestamp(data.updatedAt);

            // æ™‚é–“æ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const hasSlots = data.slots && data.slots.length > 0;

            if (hasSlots) {
                // æ™‚é–“æ ã‚’ã€Œãƒ»ã€ã§åŒºåˆ‡ã£ã¦è¡¨ç¤º
                const timeslotsText = data.slots.join('ãƒ»');

                container.className = 'display-container available';
                container.innerHTML = `
                    <div class="icon">ğŸ•</div>
                    <div class="main-message">${data.displayText}ã®äºˆç´„</div>
                    <div class="timeslots">${timeslotsText}</div>
                    <div class="sub-message">ãŒç©ºã„ã¦ã„ã¾ã™</div>
                    <div class="qr-message">å—ä»˜çª“å£ã§ã”æ¡ˆå†…ã„ãŸã—ã¾ã™</div>
                    <div class="update-time">${formattedTime}</div>
                `;

                updateFavicon(true);

            } else {
                // æº€æ ã¾ãŸã¯ä¼‘è¨ºæ—¥ã®å ´åˆ
                let message = 'æº€æ ';
                let subMessage = 'å¤§å¤‰ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“';

                if (data.status === 'closed') {
                    message = 'ä¼‘è¨ºæ—¥';
                    subMessage = 'æœ¬æ—¥ã¯ä¼‘è¨ºæ—¥ã§ã™';
                }

                container.className = 'display-container unavailable';
                container.innerHTML = `
                    <div class="icon">ğŸ˜”</div>
                    <div class="main-message">${data.displayText}ã®äºˆç´„ã¯<br>ã€Œ${message}ã€ã§ã™</div>
                    <div class="sub-message">${subMessage}</div>
                    <div class="qr-message">æ¬¡ã®è¨ºç™‚æ—¥ä»¥é™ã§ã”äºˆç´„ãã ã•ã„</div>
                    <div class="update-time">${formattedTime}</div>
                `;

                updateFavicon(false);
            }

        } catch (error) {
            console.error('ã‚¨ãƒ©ãƒ¼:', error);
            displayError();
        }
    }

    /**
     * ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã™ã‚‹é–¢æ•°
     */
    function displayError() {
        const container = document.getElementById('displayContainer');
        container.className = 'display-container error';
        container.innerHTML = `
            <div class="icon">âš ï¸</div>
            <div class="main-message">æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“</div>
            <div class="error-message">ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„</div>
        `;

        updateFavicon(false);
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    updateFavicon(true);
    updateTimeslots();

    // 1åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆ60000ãƒŸãƒªç§’ = 1åˆ†ï¼‰
    setInterval(updateTimeslots, 60000);
</script>

</body>
</html>
