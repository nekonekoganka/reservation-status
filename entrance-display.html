<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„é–¢ãƒ¢ãƒ‹ã‚¿ãƒ¼ - äºˆç´„çŠ¶æ³</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            background: #1a1a2e;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 30px;
            position: relative;
        }

        /* QRã‚³ãƒ¼ãƒ‰ - å·¦ä¸Šå›ºå®š */
        .qr-code {
            position: absolute;
            top: 30px;
            left: 30px;
            z-index: 100;
        }

        .qr-code img {
            width: 250px;
            height: 250px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .date-header {
            text-align: center;
            color: white;
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            padding-top: 20px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ */
        .cards-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
            justify-content: center;
            padding: 0 20px;
        }

        /* äºˆç´„ã‚«ãƒ¼ãƒ‰ */
        .reservation-card {
            border-radius: 20px;
            padding: 35px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .reservation-card.available {
            background: #2E7D32;
            border: 4px solid #1B5E20;
        }

        .reservation-card.unavailable {
            background: #DC3545;
            border: 4px solid #bd2130;
        }

        .reservation-card.loading {
            background: #6c757d;
            border: 4px solid #5a6268;
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ« */
        .card-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .card-status {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        /* æ™‚é–“æ ã‚³ãƒ³ãƒ†ãƒŠ */
        .timeslots {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
        }

        /* æ™‚é–“æ ãƒ”ãƒ« */
        .timeslot-pill {
            background: white;
            color: #CC6600;
            border: 3px solid #CC6600;
            border-radius: 10px;
            padding: 12px 18px;
            font-size: 28px;
            font-weight: bold;
        }

        /* ã€Œã®ã¿ã€ã€Œä»–ã€è¡¨ç¤º */
        .timeslot-more {
            color: white;
            font-size: 28px;
            font-weight: bold;
            padding: 12px 10px;
        }

        /* ã‚¹ãƒšãƒ¼ã‚µãƒ¼ï¼ˆä¸­å¤®æƒãˆç”¨ï¼‰ */
        .timeslot-spacer {
            visibility: hidden;
            font-size: 28px;
            font-weight: bold;
            padding: 12px 10px;
        }

        /* ã‚«ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .card-message {
            font-size: 30px;
            font-weight: bold;
            margin-top: 15px;
        }

        /* ã‚µãƒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .card-submessage {
            font-size: 24px;
            margin-top: 10px;
            opacity: 0.9;
        }

        /* æ¡ˆå†…ãƒ†ã‚­ã‚¹ãƒˆ */
        .guide-text {
            text-align: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
            margin: 30px 0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* æ›´æ–°æ™‚åˆ» */
        .update-time {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 24px;
            padding-bottom: 20px;
        }

        /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
        .error-card {
            background: #6c757d;
            border: 4px solid #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- QRã‚³ãƒ¼ãƒ‰ -->
        <div class="qr-code">
            <img src="Downloads/QR_fujiminohikari.png" alt="äºˆç´„QRã‚³ãƒ¼ãƒ‰">
        </div>

        <!-- æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="date-header" id="dateHeader">èª­ã¿è¾¼ã¿ä¸­...</div>

        <!-- ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="cards-container">
            <!-- ä¸€èˆ¬äºˆç´„ã‚«ãƒ¼ãƒ‰ -->
            <div class="reservation-card loading" id="generalCard">
                <div class="card-title">ä¸€èˆ¬äºˆç´„</div>
                <div class="card-status">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>

            <!-- è¦–é‡äºˆç´„ã‚«ãƒ¼ãƒ‰ -->
            <div class="reservation-card loading" id="shiyaCard">
                <div class="card-title">è¦–é‡æ¤œæŸ»äºˆç´„</div>
                <div class="card-status">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- æ¡ˆå†…ãƒ†ã‚­ã‚¹ãƒˆ -->
        <div class="guide-text">å—ä»˜çª“å£ã¾ãŸã¯WEBã§ã”äºˆç´„å‡ºæ¥ã¾ã™</div>

        <!-- æ›´æ–°æ™‚åˆ» -->
        <div class="update-time" id="updateTime"></div>
    </div>

    <script>
        // Cloud Storageã®URL
        const GENERAL_API_URL = 'https://storage.googleapis.com/fujimino-ophthalmology-reservations/timeslots.json';
        const SHIYA_API_URL = 'https://storage.googleapis.com/fujimino-ophthalmology-reservations/shiya-timeslots.json';

        /**
         * æ—¥ä»˜ã‚’ M/D å½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
         */
        function formatDateMD(date) {
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        /**
         * æ›œæ—¥ã‚’å–å¾—
         */
        function getDayOfWeekText(date) {
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            return days[date.getDay()];
        }

        /**
         * æ—¥ä»˜ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
         */
        function calculateDayText(updateTime) {
            const now = new Date(updateTime);
            const dayOfWeek = now.getDay();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const isAfter1830 = (hour > 18) || (hour === 18 && minute >= 30);
            const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

            if (dayOfWeek === 3) {
                const thursday = new Date(now);
                thursday.setDate(thursday.getDate() + 1);
                return `æœ¨æ›œï¼ˆ${formatDateMD(thursday)}ï¼‰`;
            }

            if (isAfter1830) {
                if (now.getDate() === lastDayOfMonth) {
                    return 'æ¬¡ã®è¨ºç™‚æ—¥';
                }

                if (dayOfWeek === 2) {
                    const thursday = new Date(now);
                    thursday.setDate(thursday.getDate() + 2);
                    return `æœ¨æ›œï¼ˆ${formatDateMD(thursday)}ï¼‰`;
                }

                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                return `æ˜æ—¥ï¼ˆ${formatDateMD(tomorrow)}ï¼‰`;
            }

            return `æœ¬æ—¥ï¼ˆ${formatDateMD(now)}ï¼‰`;
        }

        /**
         * ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
         */
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `æ›´æ–°ï¼š${year}/${month}/${day} ${hours}:${minutes}`;
        }

        /**
         * æ™‚é–“æ ã®HTMLã‚’ç”Ÿæˆ
         */
        function generateTimeslotsHtml(slots) {
            if (!slots || slots.length === 0) {
                return '';
            }

            const displaySlots = slots.slice(0, 4);
            const pillsHtml = displaySlots.map(slot =>
                `<span class="timeslot-pill">${slot}</span>`
            ).join('');

            if (slots.length <= 3) {
                // 1ã€œ3æ : ã‚¹ãƒšãƒ¼ã‚µãƒ¼ + æ™‚é–“æ  + ã€Œã®ã¿ã€
                return `<span class="timeslot-spacer">ã®ã¿</span>${pillsHtml}<span class="timeslot-more">ã®ã¿</span>`;
            } else if (slots.length === 4) {
                // 4æ : æ™‚é–“æ  + ã€Œã®ã¿ã€
                return `${pillsHtml}<span class="timeslot-more">ã®ã¿</span>`;
            } else {
                // 5æ ä»¥ä¸Š: æ™‚é–“æ  + ã€Œä»–ã€
                return `${pillsHtml}<span class="timeslot-more">ä»–</span>`;
            }
        }

        /**
         * ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
         */
        function updateCard(cardId, data, title) {
            const card = document.getElementById(cardId);
            const hasSlots = data.slots && data.slots.length > 0;

            if (hasSlots) {
                const timeslotsHtml = generateTimeslotsHtml(data.slots);
                card.className = 'reservation-card available';
                card.innerHTML = `
                    <div class="card-title">${title}</div>
                    <div class="card-status">âœ… ç©ºãã‚ã‚Š</div>
                    <div class="timeslots">${timeslotsHtml}</div>
                    <div class="card-message">ã« ç©ºããŒã”ã–ã„ã¾ã™</div>
                `;
            } else {
                let statusText = 'ğŸ˜” æº€æ ã§ã™';
                let submessage = 'æ¬¡ã®è¨ºç™‚æ—¥ä»¥é™ã§ã”äºˆç´„ãã ã•ã„';

                if (data.status === 'closed') {
                    statusText = 'ğŸ˜” ä¼‘è¨ºæ—¥ã§ã™';
                }

                card.className = 'reservation-card unavailable';
                card.innerHTML = `
                    <div class="card-title">${title}</div>
                    <div class="card-status">${statusText}</div>
                    <div class="card-submessage">${submessage}</div>
                `;
            }
        }

        /**
         * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
         */
        function showCardError(cardId, title) {
            const card = document.getElementById(cardId);
            card.className = 'reservation-card error-card';
            card.innerHTML = `
                <div class="card-title">${title}</div>
                <div class="card-status">âš ï¸ å–å¾—ã‚¨ãƒ©ãƒ¼</div>
                <div class="card-submessage">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</div>
            `;
        }

        /**
         * ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
         */
        async function updateDisplay() {
            let latestUpdateTime = null;

            // ä¸€èˆ¬äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            try {
                const generalResponse = await fetch(GENERAL_API_URL + '?t=' + Date.now());
                if (generalResponse.ok) {
                    const generalData = await generalResponse.json();
                    updateCard('generalCard', generalData, 'ä¸€èˆ¬äºˆç´„');
                    latestUpdateTime = generalData.updatedAt;
                } else {
                    showCardError('generalCard', 'ä¸€èˆ¬äºˆç´„');
                }
            } catch (error) {
                console.error('ä¸€èˆ¬äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showCardError('generalCard', 'ä¸€èˆ¬äºˆç´„');
            }

            // è¦–é‡äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            try {
                const shiyaResponse = await fetch(SHIYA_API_URL + '?t=' + Date.now());
                if (shiyaResponse.ok) {
                    const shiyaData = await shiyaResponse.json();
                    updateCard('shiyaCard', shiyaData, 'è¦–é‡æ¤œæŸ»äºˆç´„');
                    if (!latestUpdateTime) {
                        latestUpdateTime = shiyaData.updatedAt;
                    }
                } else {
                    showCardError('shiyaCard', 'è¦–é‡æ¤œæŸ»äºˆç´„');
                }
            } catch (error) {
                console.error('è¦–é‡äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showCardError('shiyaCard', 'è¦–é‡æ¤œæŸ»äºˆç´„');
            }

            // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›´æ–°
            if (latestUpdateTime) {
                const dayText = calculateDayText(latestUpdateTime);
                document.getElementById('dateHeader').textContent = dayText;
                document.getElementById('updateTime').textContent = formatTimestamp(latestUpdateTime);
            } else {
                document.getElementById('dateHeader').textContent = 'æœ¬æ—¥';
                document.getElementById('updateTime').textContent = 'æ›´æ–°ï¼š--';
            }
        }

        // åˆå›å®Ÿè¡Œ
        updateDisplay();

        // 1åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°
        setInterval(updateDisplay, 60000);
    </script>
</body>
</html>
