# 📝 視野予約の古い行自動削除機能 - 設定手順

## 🎯 機能概要

**目的：**
視野予約のスプレッドシートが20,000行を超えたら、古い行を自動削除してパフォーマンスを維持

**仕様：**
- 上限：20,000行
- 保持期間：約1ヶ月分のデータ
- 実行タイミング：毎週水曜日 午前3時
- 削除方法：古い行から削除（ヘッダー行は残す）

**対象シート：**
- スプレッドシートID：`1RSd9aC5B_-gQ1_j5V1aQcZn1iVw9v8mpmhJ78_8gY80`
- シート名：`フォームの回答_視野予約`

---

## 🔧 設定手順

### ステップ1：GASにコードを追加

1. **スプレッドシートを開く**
   - https://docs.google.com/spreadsheets/d/1RSd9aC5B_-gQ1_j5V1aQcZn1iVw9v8mpmhJ78_8gY80/edit

2. **「拡張機能」→「Apps Script」をクリック**

3. **既存のGASファイルを開く、または新規作成**
   - 視野予約用のGAS（`google-apps-script-shiya.js`）に追加するのが推奨
   - または左側の「+」ボタンをクリック → 「スクリプト」を選択

4. **ファイル名を設定**
   - 新規作成の場合：「視野予約_古い行削除.gs」
   - 既存ファイルに追加の場合：そのまま

5. **`gas/delete-old-rows-shiya.gs` の内容をコピー&ペースト**
   - 既存のGASファイルに追加する場合は、下部に追加

6. **「保存」ボタンをクリック**

---

### ステップ2：テスト実行

1. **関数選択ドロップダウンで「testDeleteOldRows_Shiya」を選択**

2. **「実行」ボタン（▶）をクリック**

3. **初回は権限の承認が必要**
   - 「権限を確認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「（プロジェクト名）に移動」をクリック
   - 「許可」をクリック

4. **実行ログを確認**
   - 下部の「実行ログ」タブをクリック
   - 「【視野予約】現在の行数: ◯◯」
   - 「【視野予約】行数が上限以下のため、削除不要です」または「【視野予約】削除完了: ◯◯行を削除しました」

---

### ステップ3：自動実行のトリガーを設定

1. **左側のメニューで「トリガー」（時計アイコン）をクリック**

2. **右下の「トリガーを追加」ボタンをクリック**

3. **設定：**

   **実行する関数を選択：**
   - `deleteOldRows_Shiya`

   **実行するデプロイを選択：**
   - `Head`

   **イベントのソースを選択：**
   - `時間主導型`

   **時間ベースのトリガーのタイプを選択：**
   - `週ベースのタイマー`

   **曜日を選択：**
   - `水曜日`

   **時刻を選択：**
   - `午前3時~4時`

4. **「保存」ボタンをクリック**

5. **完了！**

---

## ✅ 設定確認

### トリガー一覧で確認

- 関数：`deleteOldRows_Shiya`
- イベント：`時間主導型`
- 頻度：`毎週水曜 午前3時~4時`

**注意：** 一般予約用の `deleteOldRows` と両方設定されている状態が正常です。

---

## 🧪 動作テスト

### テスト1：手動実行（今すぐ）

1. 関数「testDeleteOldRows_Shiya」を選択
2. 実行ボタンをクリック
3. ログを確認

**期待される動作：**
- 【視野予約】現在の行数が表示される
- 20,000行以下 → 「【視野予約】削除不要」
- 20,000行超 → 「【視野予約】◯◯行を削除しました」

---

### テスト2：自動実行（次の水曜日）

**確認方法：**

1. **次の水曜日の午前4時以降にスプレッドシートを確認**

2. **GASの実行履歴を確認**
   - Apps Scriptで「実行数」をクリック
   - 水曜日の午前3時頃に「deleteOldRows_Shiya」が実行されているか確認
   - ログの内容を確認

---

## 📊 動作イメージ

### ケース1：15,000行の場合

```
【視野予約】現在の行数: 15,000
【視野予約】行数が上限以下のため、削除不要です
```

→ 何もしない ✅

---

### ケース2：25,000行の場合

```
【視野予約】現在の行数: 25,000
【視野予約】削除する行数: 5,000
【視野予約】削除完了: 5,000行を削除しました
【視野予約】残り行数: 20,000
```

→ 古い5,000行を削除 ✅

---

## ⚠️ 注意事項

### 削除されたデータは復元できません

- 削除前にバックアップが必要な場合は、別途対応が必要です
- 通常の運用では、約1ヶ月分のデータが常に残ります

### タイミング

- 毎週水曜日の午前3時〜4時の間に実行
- 診療時間外なので、業務に影響しません

### 一般予約と視野予約の両方を設定

- 一般予約：`deleteOldRows` トリガー
- 視野予約：`deleteOldRows_Shiya` トリガー
- 両方とも水曜日午前3時に実行され、それぞれのシートを独立して管理します

### エラー時

- GASからメール通知が来る場合があります
- 「実行数」でエラーログを確認できます

---

## 🔧 カスタマイズ

### 保持する行数を変更したい場合

**`delete-old-rows-shiya.gs` の18行目を変更：**

```javascript
const MAX_ROWS_SHIYA = 20000; // この数字を変更
```

例：
- 10,000行に変更 → `const MAX_ROWS_SHIYA = 10000;`
- 30,000行に変更 → `const MAX_ROWS_SHIYA = 30000;`

変更後、「保存」をクリック

---

### 実行タイミングを変更したい場合

**トリガーを編集：**

1. 「トリガー」画面で、該当トリガーの「︙」→「編集」
2. 曜日や時刻を変更
3. 「保存」

---

## 🎉 完了！

これで、視野予約のスプレッドシートが20,000行を超えても、自動的に古いデータが削除され、パフォーマンスが維持されます。

**現在の設定状況：**
- ✅ 一般予約：`deleteOldRows` （フォームの回答 1）
- ✅ 視野予約：`deleteOldRows_Shiya` （フォームの回答_視野予約）

---

## 💡 その他

### バックアップが必要な場合

古いデータを別シートに移動する機能も追加できます。
必要であれば、お知らせください。

### 質問・トラブル

何か問題があれば、いつでもご連絡ください！😊
