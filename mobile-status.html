<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äºˆç´„çŠ¶æ³ãƒã‚§ãƒƒã‚«ãƒ¼</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 600px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 30px 20px;
    }

    h1 {
      text-align: center;
      font-size: 24px;
      color: #333;
      margin-bottom: 30px;
      font-weight: 700;
    }

    .cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 30px;
    }

    .card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .card:active {
      transform: scale(0.98);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #666;
      margin-bottom: 15px;
    }

    .icon-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 15px;
    }

    canvas {
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .status {
      font-size: 20px;
      font-weight: 700;
      margin-top: 10px;
    }

    .status.available {
      color: #27ae60;
    }

    .status.full {
      color: #dc3545;
    }

    .status.error {
      color: #999;
    }

    .footer {
      text-align: center;
      margin-top: 20px;
    }

    .update-time {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }

    .refresh-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s;
    }

    .refresh-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .refresh-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-left: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 400px) {
      .cards {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>äºˆç´„çŠ¶æ³ãƒã‚§ãƒƒã‚«ãƒ¼</h1>

    <div class="cards">
      <!-- ä¸€èˆ¬äºˆç´„ -->
      <div class="card">
        <div class="card-title">ä¸€èˆ¬äºˆç´„</div>
        <div class="icon-wrapper">
          <canvas id="canvas-general" width="128" height="128"></canvas>
        </div>
        <div id="status-general" class="status">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>

      <!-- è¦–é‡äºˆç´„ -->
      <div class="card">
        <div class="card-title">è¦–é‡äºˆç´„</div>
        <div class="icon-wrapper">
          <canvas id="canvas-shiya" width="128" height="128"></canvas>
        </div>
        <div id="status-shiya" class="status">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

    <div class="footer">
      <div id="update-time" class="update-time">æ›´æ–°ä¸­...</div>
      <button id="refresh-btn" class="refresh-btn">ğŸ”„ æ›´æ–°</button>
    </div>
  </div>

  <script>
    const SPREADSHEET_ID = '1RSd9aC5B_-gQ1_j5V1aQcZn1iVw9v8mpmhJ78_8gY80';
    const SHEETS = {
      general: 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­” 1',
      shiya: 'ãƒ•ã‚©ãƒ¼ãƒ ã®å›ç­”_è¦–é‡äºˆç´„'
    };

    // Canvas APIã§2Ã—2ã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’æç”»
    function drawIcon(canvasId, isAvailable, themeColor, text) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      const size = 128;
      const cellSize = size / 2;
      const borderRadius = size * 0.15;

      // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
      ctx.clearRect(0, 0, size, size);

      // èƒŒæ™¯è‰²
      const bgColor = isAvailable ? '#27ae60' : '#dc3545';

      // å·¦ä¸Š3ãƒã‚¹ï¼ˆäºˆç´„çŠ¶æ³ï¼‰
      ctx.fillStyle = bgColor;

      // å·¦ä¸Š
      ctx.beginPath();
      ctx.moveTo(borderRadius, 0);
      ctx.lineTo(cellSize, 0);
      ctx.lineTo(cellSize, cellSize);
      ctx.lineTo(0, cellSize);
      ctx.lineTo(0, borderRadius);
      ctx.arcTo(0, 0, borderRadius, 0, borderRadius);
      ctx.closePath();
      ctx.fill();

      // å³ä¸Š
      ctx.beginPath();
      ctx.moveTo(cellSize, 0);
      ctx.lineTo(size - borderRadius, 0);
      ctx.arcTo(size, 0, size, borderRadius, borderRadius);
      ctx.lineTo(size, cellSize);
      ctx.lineTo(cellSize, cellSize);
      ctx.closePath();
      ctx.fill();

      // å·¦ä¸‹
      ctx.beginPath();
      ctx.moveTo(0, cellSize);
      ctx.lineTo(cellSize, cellSize);
      ctx.lineTo(cellSize, size);
      ctx.lineTo(borderRadius, size);
      ctx.arcTo(0, size, 0, size - borderRadius, borderRadius);
      ctx.lineTo(0, cellSize);
      ctx.closePath();
      ctx.fill();

      // å³ä¸‹1ãƒã‚¹ï¼ˆãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼+æ–‡å­—ï¼‰
      ctx.fillStyle = themeColor;
      ctx.beginPath();
      ctx.moveTo(cellSize, cellSize);
      ctx.lineTo(size, cellSize);
      ctx.lineTo(size, size - borderRadius);
      ctx.arcTo(size, size, size - borderRadius, size, borderRadius);
      ctx.lineTo(cellSize, size);
      ctx.lineTo(cellSize, cellSize);
      ctx.closePath();
      ctx.fill();

      // ç™½æ–‡å­—ã‚’å³ä¸‹ãƒã‚¹ã«æç”»
      ctx.fillStyle = 'white';
      ctx.font = `bold ${cellSize * 0.7}px sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(text, cellSize + cellSize / 2, cellSize + cellSize / 2);

      // ä¸­å¤®ã«ãƒãƒ¼ã‚¯ã‚’æç”»ï¼ˆç©ºãã‚ã‚Š:â—¯ã€æº€æ :âœ•ï¼‰
      if (isAvailable) {
        // ç©ºãã‚ã‚Šï¼šç™½ã„ä¸¸â—¯
        ctx.fillStyle = 'white';
        ctx.font = `bold ${size * 0.6}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('â—¯', size / 2, size / 2);
      } else {
        // æº€æ ï¼šå¤ªã„ãƒãƒ„âœ•ï¼ˆç·šã§æç”»ï¼‰
        ctx.strokeStyle = 'white';
        ctx.lineWidth = size * 0.12;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(size * 0.3, size * 0.3);
        ctx.lineTo(size * 0.7, size * 0.7);
        ctx.moveTo(size * 0.7, size * 0.3);
        ctx.lineTo(size * 0.3, size * 0.7);
        ctx.stroke();
      }
    }

    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
    async function fetchSheetData(sheetName) {
      const apiUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;

      try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const text = await response.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));

        if (!json.table || !json.table.rows || json.table.rows.length === 0) {
          throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }

        const rows = json.table.rows;
        const lastRow = rows[rows.length - 1];

        if (!lastRow.c || lastRow.c.length < 2) {
          throw new Error('ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™');
        }

        const timestamp = lastRow.c[0]?.f || lastRow.c[0]?.v || '';
        const status = lastRow.c[1]?.v || '';
        const isAvailable = status.includes('ç©ºãã‚ã‚Š') || status.includes('ç©ºã');

        return { timestamp, status, isAvailable };
      } catch (error) {
        console.error(`[${sheetName}] ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
        return null;
      }
    }

    // ä¸¡æ–¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    async function updateAll() {
      const btn = document.getElementById('refresh-btn');
      btn.disabled = true;
      btn.innerHTML = 'æ›´æ–°ä¸­<span class="loading"></span>';

      try {
        // ä¸€èˆ¬äºˆç´„
        const generalData = await fetchSheetData(SHEETS.general);
        if (generalData) {
          drawIcon('canvas-general', generalData.isAvailable, '#F57C00', 'ä¸€');
          document.getElementById('status-general').textContent = generalData.isAvailable ? 'â—¯ ç©ºãã‚ã‚Š' : 'âœ• æº€æ ';
          document.getElementById('status-general').className = generalData.isAvailable ? 'status available' : 'status full';
        } else {
          document.getElementById('status-general').textContent = 'ã‚¨ãƒ©ãƒ¼';
          document.getElementById('status-general').className = 'status error';
        }

        // è¦–é‡äºˆç´„
        const shiyaData = await fetchSheetData(SHEETS.shiya);
        if (shiyaData) {
          drawIcon('canvas-shiya', shiyaData.isAvailable, '#4CAF50', 'é‡');
          document.getElementById('status-shiya').textContent = shiyaData.isAvailable ? 'â—¯ ç©ºãã‚ã‚Š' : 'âœ• æº€æ ';
          document.getElementById('status-shiya').className = shiyaData.isAvailable ? 'status available' : 'status full';
        } else {
          document.getElementById('status-shiya').textContent = 'ã‚¨ãƒ©ãƒ¼';
          document.getElementById('status-shiya').className = 'status error';
        }

        // æ›´æ–°æ™‚åˆ»
        const now = new Date();
        const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('update-time').textContent = `æœ€çµ‚æ›´æ–°: ${timeStr}`;

      } catch (error) {
        console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ æ›´æ–°';
      }
    }

    // æ›´æ–°ãƒœã‚¿ãƒ³
    document.getElementById('refresh-btn').addEventListener('click', updateAll);

    // åˆå›èª­ã¿è¾¼ã¿
    updateAll();

    // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
    setInterval(updateAll, 30000);
  </script>
</body>
</html>
