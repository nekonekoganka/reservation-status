<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äºˆç´„çŠ¶æ³ãƒã‚§ãƒƒã‚«ãƒ¼ï¼ˆæ™‚é–“æ å¯¾å¿œï¼‰</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 700px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 15px 15px;
    }

    .cards {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 15px;
    }

    .card-wrapper {
      display: flex;
      flex-direction: column;
    }

    .card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      cursor: pointer;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .card:active {
      transform: scale(0.98);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-wrapper {
      flex-shrink: 0;
    }

    canvas {
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .card-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      color: #666;
      margin-bottom: 4px;
    }

    .status {
      font-size: 20px;
      font-weight: 700;
    }

    .status.available {
      color: #27ae60;
    }

    .status.full {
      color: #dc3545;
    }

    .status.error {
      color: #999;
    }

    .day-text {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin-top: 4px;
    }

    /* æ™‚é–“æ ãƒªã‚¹ãƒˆï¼ˆã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«å±•é–‹ï¼‰ */
    .timeslots-container {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease-out;
      margin-top: 0;
    }

    .timeslots-container.expanded {
      max-height: 2000px; /* ååˆ†ãªé«˜ã•ã‚’ç¢ºä¿ */
      margin-top: 8px;
    }

    .timeslots-header {
      font-size: 12px;
      font-weight: 600;
      color: #666;
      margin-bottom: 6px;
      padding-bottom: 6px;
      border-bottom: 2px solid #e0e0e0;
    }

    .timeslots-list {
      background: white;
      border-radius: 8px;
      padding: 8px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .timeslot-item {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 10px 8px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 24px;
      font-weight: 600;
      color: #333;
      border: 1px solid #e0e0e0;
    }

    /* åˆå‰ï¼ˆ14æ™‚ã‚ˆã‚Šå‰ï¼‰: é’èƒŒæ™¯ */
    .timeslot-item.am {
      background: #e8f4fc;
      border-color: #3498db;
    }

    /* åˆå¾Œï¼ˆ14æ™‚ä»¥é™ï¼‰: ã‚ªãƒ¬ãƒ³ã‚¸èƒŒæ™¯ */
    .timeslot-item.pm {
      background: #fdf2e9;
      border-color: #e67e22;
    }

    .timeslot-icon {
      color: #27ae60;
      font-size: 16px;
    }

    .no-slots {
      text-align: center;
      color: #999;
      font-size: 13px;
      padding: 15px;
    }

    /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒãƒ¼ï¼ˆã‚»ãƒ«ãƒãƒ¼å½¢å¼ï¼šåˆå‰/åˆå¾Œï¼‰ */
    .timeline-container {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .timeline-block {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
    }

    .timeline-block.am {
      background: linear-gradient(135deg, #fff9f0, #fff3e0);
    }

    .timeline-block.pm {
      background: linear-gradient(135deg, #f0f7ff, #e3f2fd);
    }

    .timeline-period {
      font-size: 13px;
      font-weight: 700;
      color: #555;
      min-width: 32px;
      flex-shrink: 0;
    }

    .timeline-content {
      flex: 1;
      min-width: 0;
    }

    .timeline-bar {
      display: flex;
      width: 100%;
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid #ccc;
    }

    .timeline-cell {
      flex: 1;
      height: 24px;
      border-right: 1px solid #ddd;
      box-sizing: border-box;
    }

    .timeline-cell:last-child {
      border-right: none;
    }

    .timeline-cell.general.available {
      background: white;
    }

    .timeline-cell.general.filled {
      background: #CC6600;
    }

    .timeline-cell.shiya.available {
      background: white;
    }

    .timeline-cell.shiya.filled {
      background: #006633;
    }

    .timeline-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      padding: 0;
    }

    .timeline-label {
      font-size: 12px;
      color: #333;
      font-weight: 700;
      width: 22px;
      text-align: center;
    }

    .expand-indicator {
      text-align: center;
      font-size: 11px;
      color: #666;
      margin-top: 8px;
      font-weight: 500;
    }

    /* å¤§ç”»é¢ç”¨ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤ºã€å¤§ç”»é¢ãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤ºï¼‰ */
    .card-title-large {
      display: none;
    }

    .footer {
      text-align: center;
      margin-top: 10px;
    }

    .update-time {
      font-size: 24px;
      color: #666;
      margin-bottom: 8px;
    }

    .footer-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .dashboard-btn {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dashboard-btn:active {
      transform: scale(0.95);
      background: #f0f0ff;
    }

    .refresh-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s;
    }

    .refresh-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .refresh-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-left: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* å£æ›ã‘ãƒ¢ãƒ¼ãƒ‰: 801pxä»¥ä¸Šï¼ˆvwå˜ä½ã§è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰ */
    @media (min-width: 801px) {
      .container {
        max-width: 98vw;
        padding: 1.5vw;
      }

      .cards {
        flex-direction: row;
        gap: 0;
        align-items: flex-start;
      }

      .card-wrapper {
        flex: 1;
        min-width: 0;
      }

      /* ä¸€èˆ¬äºˆç´„: è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸èƒŒæ™¯ + ä¸­å¤®åˆ†å‰²ç·šï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ */
      .card-wrapper.general-wrapper .card {
        background: #fff8f0;
        border-right: 4px solid #888888;
      }

      /* è¦–é‡äºˆç´„: è–„ã„ç·‘èƒŒæ™¯ */
      .card-wrapper.shiya-wrapper .card {
        background: #f0fff4;
      }

      .card {
        cursor: default;
        padding: 1.5vw;
        border-radius: 1.5vw;
      }

      /* å¤§ç”»é¢ç”¨ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ¨ªä¸¦ã³ãƒ»å¤§ãããƒ»ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼‰ */
      .card-title-large {
        display: flex;
        align-items: center;
        font-size: 5vw;
        font-weight: 800;
        padding: 0 1.5vw;
      }

      .card-title-large.general {
        color: #CC6600;
      }

      .card-title-large.shiya {
        color: #006633;
      }

      /* é€šå¸¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã¯éè¡¨ç¤º */
      .card-title {
        display: none;
      }

      .card:hover {
        transform: none;
      }

      .card:active {
        transform: none;
      }

      /* æ™‚é–“æ ãƒªã‚¹ãƒˆã‚’å¸¸ã«è¡¨ç¤º */
      .timeslots-container {
        max-height: 2000px !important;
        margin-top: 1vw;
      }

      /* æ™‚é–“å¸¯è©³ç´°ã«ã‚‚èƒŒæ™¯è‰²ã¨åˆ†å‰²ç·šã‚’é©ç”¨ */
      .card-wrapper.general-wrapper .timeslots-container {
        background: #fff8f0;
        border-right: 4px solid #888888;
        padding: 1vw;
        border-radius: 0 0 1vw 1vw;
      }

      .card-wrapper.shiya-wrapper .timeslots-container {
        background: #f0fff4;
        padding: 1vw;
        border-radius: 0 0 1vw 1vw;
      }

      /* å±•é–‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’éè¡¨ç¤º */
      .expand-indicator {
        display: none !important;
      }

      /* ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ« */
      .card-title {
        font-size: 1.8vw;
        margin-bottom: 0.5vw;
      }

      /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæ®‹ã‚Šâ—‹æ ï¼‰ */
      .status {
        font-size: 3.5vw;
      }

      /* æ—¥ä»˜ãƒ†ã‚­ã‚¹ãƒˆ */
      .day-text {
        font-size: 2.5vw;
        margin-top: 0.5vw;
      }

      /* ã‚¢ã‚¤ã‚³ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ */
      canvas {
        width: 10vw !important;
        height: 10vw !important;
        min-width: 80px;
        min-height: 80px;
      }

      .card-header {
        gap: 1.5vw;
        align-items: center;
      }

      /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒãƒ¼ï¼ˆ2æœ¬æ§‹æˆï¼‰ */
      .timeline-container {
        margin-top: 1.2vw;
        padding: 0.8vw 0.5vw;
        gap: 0.8vw;
      }

      .timeline-bar {
        border-radius: 4px;
      }

      .timeline-cell {
        height: max(2.5vw, 24px);
      }

      .timeline-dot {
        width: 1.5vw;
        height: 1.5vw;
        min-width: 16px;
        min-height: 16px;
        border-width: 0.3vw;
      }

      .timeline-label {
        font-size: 1.8vw;
        width: 2.2vw;
        min-width: 20px;
      }

      .timeline-labels {
        margin-top: 0.5vw;
      }

      /* æ™‚é–“æ ãƒªã‚¹ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ4åˆ—ï¼‰ */
      .timeslots-list {
        padding: 0.8vw;
        gap: 0.8vw;
        grid-template-columns: repeat(4, 1fr);
      }

      /* 8æ ä»¥ä¸Šã®ã¨ã6åˆ—ã«å¤‰æ›´ */
      .timeslots-list.many-slots {
        padding: 0.6vw;
        gap: 0.5vw;
        grid-template-columns: repeat(6, 1fr);
      }

      .timeslot-item {
        padding: 1vw 0.8vw;
        font-size: 2.5vw;
        border-radius: 0.8vw;
        border-width: 2px;
      }

      /* 8æ ä»¥ä¸Šã®ã¨ãã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º */
      .timeslots-list.many-slots .timeslot-item {
        padding: 0.6vw 0.5vw;
        font-size: 2vw;
        border-radius: 0.6vw;
      }

      /* ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ1è¡Œï¼‰ */
      .footer {
        margin-top: 0.8vw;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1.5vw;
        background: #f5f5f5;
        padding: 0.5vw 1vw;
        border-radius: 1vw;
      }

      .update-time {
        font-size: 1.5vw;
      }

      .refresh-btn {
        padding: 0.5vw 1.5vw;
        font-size: 1vw;
        border-radius: 1.5vw;
      }

      .dashboard-btn {
        padding: 0.5vw 1.2vw;
        font-size: 1vw;
        border-radius: 1.5vw;
        border-width: 0.15vw;
      }

      .footer-buttons {
        gap: 1vw;
      }
    }

    /* ã‚¹ãƒãƒ›ãƒ¢ãƒ¼ãƒ‰: 800pxä»¥ä¸‹ */
    @media (max-width: 800px) {
      body {
        padding: 8px;
      }

      .container {
        padding: 8px;
      }

      .cards {
        gap: 10px;
      }

      .card {
        padding: 8px;
        border-radius: 10px;
      }

      /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒãƒ¼ã‚’æ¨ªå¹…ã„ã£ã±ã„ã« */
      .timeline-container {
        margin: 10px -4px 0;
        padding: 6px 0;
        gap: 6px;
      }

      .timeslots-list {
        grid-template-columns: repeat(2, 1fr);
      }

      /* ã‚¹ãƒãƒ›ã§ãƒ‰ãƒƒãƒˆã‚’å¤§ããï¼ˆ1.5å€ï¼‰ */
      .timeline-dot {
        width: 18px;
        height: 18px;
        border-width: 3px;
      }

      /* ã‚¹ãƒãƒ›ã§æ™‚é–“ãƒ©ãƒ™ãƒ«ã‚’å¤§ããï¼ˆ1.5å€ï¼‰ */
      .timeline-label {
        font-size: 17px;
        width: 27px;
      }

      /* ã‚»ãƒ«é«˜ã•ã‚’æ‹¡å¤§ */
      .timeline-cell {
        height: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="cards">
      <!-- ä¸€èˆ¬äºˆç´„ -->
      <div class="card-wrapper general-wrapper">
        <div class="card" id="card-general" onclick="toggleTimeslots('general')">
          <div class="card-header">
            <div class="icon-wrapper">
              <canvas id="canvas-general" width="128" height="128"></canvas>
            </div>
            <div class="card-title-large general">ä¸€èˆ¬</div>
            <div class="card-info">
              <div class="card-title">ä¸€èˆ¬äºˆç´„</div>
              <div id="status-general" class="status">èª­ã¿è¾¼ã¿ä¸­...</div>
              <div id="day-text-general" class="day-text"></div>
            </div>
          </div>
          <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒãƒ¼ï¼ˆã‚»ãƒ«ãƒãƒ¼å½¢å¼ï¼šåˆå‰/åˆå¾Œï¼‰ -->
          <div class="timeline-container">
            <!-- åˆå‰ãƒ–ãƒ­ãƒƒã‚¯ -->
            <div class="timeline-block am">
              <span class="timeline-period">åˆå‰</span>
              <div class="timeline-content">
                <div id="timeline-bar-general-am" class="timeline-bar">
                  <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                <div class="timeline-labels">
                  <span class="timeline-label">10</span>
                  <span class="timeline-label">11</span>
                  <span class="timeline-label">12</span>
                  <span class="timeline-label">13</span>
                </div>
              </div>
            </div>
            <!-- åˆå¾Œãƒ–ãƒ­ãƒƒã‚¯ -->
            <div class="timeline-block pm">
              <span class="timeline-period">åˆå¾Œ</span>
              <div class="timeline-content">
                <div id="timeline-bar-general-pm" class="timeline-bar">
                  <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                <div class="timeline-labels">
                  <span class="timeline-label">15</span>
                  <span class="timeline-label">16</span>
                  <span class="timeline-label">17</span>
                  <span class="timeline-label">18</span>
                </div>
              </div>
            </div>
          </div>

          <div id="expand-general" class="expand-indicator">
            â–¼ è©³ç´°ã‚’è¡¨ç¤º
          </div>
        </div>

        <!-- æ™‚é–“æ ãƒªã‚¹ãƒˆï¼ˆã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«å±•é–‹ï¼‰ -->
        <div id="timeslots-general" class="timeslots-container">
          <div id="timeslots-list-general" class="timeslots-list">
            <div class="no-slots">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- è¦–é‡äºˆç´„ -->
      <div class="card-wrapper shiya-wrapper">
        <div class="card" id="card-shiya" onclick="toggleTimeslots('shiya')">
          <div class="card-header">
            <div class="icon-wrapper">
              <canvas id="canvas-shiya" width="128" height="128"></canvas>
            </div>
            <div class="card-title-large shiya">è¦–é‡</div>
            <div class="card-info">
              <div class="card-title">è¦–é‡äºˆç´„</div>
              <div id="status-shiya" class="status">èª­ã¿è¾¼ã¿ä¸­...</div>
              <div id="day-text-shiya" class="day-text"></div>
            </div>
          </div>
          <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒãƒ¼ï¼ˆã‚»ãƒ«ãƒãƒ¼å½¢å¼ï¼šåˆå‰/åˆå¾Œï¼‰ -->
          <div class="timeline-container">
            <!-- åˆå‰ãƒ–ãƒ­ãƒƒã‚¯ -->
            <div class="timeline-block am">
              <span class="timeline-period">åˆå‰</span>
              <div class="timeline-content">
                <div id="timeline-bar-shiya-am" class="timeline-bar">
                  <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                <div class="timeline-labels">
                  <span class="timeline-label">10</span>
                  <span class="timeline-label">11</span>
                  <span class="timeline-label">12</span>
                  <span class="timeline-label">13</span>
                </div>
              </div>
            </div>
            <!-- åˆå¾Œãƒ–ãƒ­ãƒƒã‚¯ -->
            <div class="timeline-block pm">
              <span class="timeline-period">åˆå¾Œ</span>
              <div class="timeline-content">
                <div id="timeline-bar-shiya-pm" class="timeline-bar">
                  <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                <div class="timeline-labels">
                  <span class="timeline-label">15</span>
                  <span class="timeline-label">16</span>
                  <span class="timeline-label">17</span>
                  <span class="timeline-label">18</span>
                </div>
              </div>
            </div>
          </div>

          <div id="expand-shiya" class="expand-indicator">
            â–¼ è©³ç´°ã‚’è¡¨ç¤º
          </div>
        </div>

        <!-- æ™‚é–“æ ãƒªã‚¹ãƒˆï¼ˆã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«å±•é–‹ï¼‰ -->
        <div id="timeslots-shiya" class="timeslots-container">
          <div id="timeslots-list-shiya" class="timeslots-list">
            <div class="no-slots">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div id="update-time" class="update-time">æ›´æ–°ä¸­...</div>
      <div class="footer-buttons">
        <a href="dashboard.html" class="dashboard-btn">ğŸ“Š è§£æ</a>
        <button id="refresh-btn" class="refresh-btn">ğŸ”„ æ›´æ–°</button>
      </div>
    </div>
  </div>

  <script>
    // Cloud Storageã®URL
    const TIMESLOTS_URLS = {
      general: 'https://storage.googleapis.com/reservation-timeslots-fujiminohikari/timeslots.json',
      shiya: 'https://storage.googleapis.com/reservation-timeslots-fujiminohikari/timeslots-shiya.json'
    };

    // å±•é–‹çŠ¶æ…‹ã‚’ç®¡ç†ï¼ˆåˆæœŸçŠ¶æ…‹ã§æŠ˜ã‚ŠãŸãŸã¿ï¼‰
    const expandedState = {
      general: false,
      shiya: false
    };

    // ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆå†æç”»ç”¨ï¼‰
    const slotsData = {
      general: [],
      shiya: []
    };

    /**
     * æ™‚é–“æ ãƒªã‚¹ãƒˆã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
     */
    function toggleTimeslots(type) {
      const container = document.getElementById(`timeslots-${type}`);
      const indicator = document.getElementById(`expand-${type}`);

      expandedState[type] = !expandedState[type];

      if (expandedState[type]) {
        container.classList.add('expanded');
        indicator.textContent = 'â–² é–‰ã˜ã‚‹';
      } else {
        container.classList.remove('expanded');
        indicator.textContent = 'â–¼ è©³ç´°ã‚’è¡¨ç¤º';
      }
    }

    /**
     * Canvas APIã§ã‚¢ã‚¤ã‚³ãƒ³ã‚’æç”»ï¼ˆæ æ•°ã‚’æ•°å­—ã§è¡¨ç¤ºï¼‰
     */
    function drawIcon(canvasId, slotsCount, status, themeColor, text) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      const size = 128;
      const cellSize = size / 2;
      const borderRadius = size * 0.15;

      // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
      ctx.clearRect(0, 0, size, size);

      // æ æ•° > 0 ã®å ´åˆã¯ç™½èƒŒæ™¯+è‰²æ +ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼æ•°å­—ã®ãƒ‡ã‚¶ã‚¤ãƒ³
      if (status !== 'error' && slotsCount > 0) {
        const borderWidth = Math.max(1, Math.round(size * 0.08)); // æ ç·šã®å¤ªã•ï¼ˆ8%ã€æœ€å°1pxï¼‰

        // ç™½èƒŒæ™¯ã§å¡—ã‚Šã¤ã¶ã—
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, size, size);

        // å¤–æ ã‚’æç”»
        ctx.strokeStyle = themeColor;
        ctx.lineWidth = borderWidth;
        ctx.strokeRect(borderWidth / 2, borderWidth / 2, size - borderWidth, size - borderWidth);

        // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã®å¤ªã„æ•°å­—ã‚’æœ€å¤§ã‚µã‚¤ã‚ºã§è¡¨ç¤º
        ctx.fillStyle = themeColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // æ•°å­—ã®ã‚µã‚¤ã‚ºã‚’ã•ã‚‰ã«å¤§ããï¼ˆ1æ¡ã¯95%ã€2æ¡ã¯80%ï¼‰
        const fontSize = slotsCount >= 10 ? size * 0.8 : size * 0.95;
        ctx.font = `bold ${fontSize}px sans-serif`;

        // è¦–è¦šçš„ãªä¸­å¤®ã«é…ç½®ï¼ˆWebãƒšãƒ¼ã‚¸ã§ã¯è£œæ­£ãªã—ã§ä¸­å¤®ã«ï¼‰
        ctx.fillText(slotsCount.toString(), size / 2, size / 2);
      } else {
        // æ æ•° = 0 ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ—¢å­˜ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆ2Ã—2ã‚°ãƒªãƒƒãƒ‰ï¼‰
        // èƒŒæ™¯è‰²ã‚’æ±ºå®š
        let bgColor;
        if (status === 'error') {
          bgColor = '#FFA500'; // ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
        } else {
          bgColor = '#dc3545'; // èµ¤ï¼ˆæº€æ ï¼‰
        }

        // å·¦ä¸Š3ãƒã‚¹ï¼ˆäºˆç´„çŠ¶æ³ï¼‰
        ctx.fillStyle = bgColor;

        // å·¦ä¸Š
        ctx.beginPath();
        ctx.moveTo(borderRadius, 0);
        ctx.lineTo(cellSize, 0);
        ctx.lineTo(cellSize, cellSize);
        ctx.lineTo(0, cellSize);
        ctx.lineTo(0, borderRadius);
        ctx.arcTo(0, 0, borderRadius, 0, borderRadius);
        ctx.closePath();
        ctx.fill();

        // å³ä¸Š
        ctx.beginPath();
        ctx.moveTo(cellSize, 0);
        ctx.lineTo(size - borderRadius, 0);
        ctx.arcTo(size, 0, size, borderRadius, borderRadius);
        ctx.lineTo(size, cellSize);
        ctx.lineTo(cellSize, cellSize);
        ctx.closePath();
        ctx.fill();

        // å·¦ä¸‹
        ctx.beginPath();
        ctx.moveTo(0, cellSize);
        ctx.lineTo(cellSize, cellSize);
        ctx.lineTo(cellSize, size);
        ctx.lineTo(borderRadius, size);
        ctx.arcTo(0, size, 0, size - borderRadius, borderRadius);
        ctx.lineTo(0, cellSize);
        ctx.closePath();
        ctx.fill();

        // å³ä¸‹1ãƒã‚¹ï¼ˆãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼+æ–‡å­—ï¼‰
        ctx.fillStyle = themeColor;
        ctx.beginPath();
        ctx.moveTo(cellSize, cellSize);
        ctx.lineTo(size, cellSize);
        ctx.lineTo(size, size - borderRadius);
        ctx.arcTo(size, size, size - borderRadius, size, borderRadius);
        ctx.lineTo(cellSize, size);
        ctx.lineTo(cellSize, cellSize);
        ctx.closePath();
        ctx.fill();

        // ç™½æ–‡å­—ã‚’å³ä¸‹ãƒã‚¹ã«æç”»
        ctx.fillStyle = 'white';
        ctx.font = `bold ${cellSize * 0.7}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, cellSize + cellSize / 2, cellSize + cellSize / 2);

        // ä¸­å¤®ã«ãƒãƒ¼ã‚¯ã‚’æç”»
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        if (status === 'error') {
          // ã‚¨ãƒ©ãƒ¼ï¼šâš ãƒãƒ¼ã‚¯
          ctx.fillStyle = 'white';
          ctx.font = `bold ${size * 0.6}px sans-serif`;
          ctx.fillText('âš ', size / 2, size / 2);
        } else {
          // æº€æ ï¼šå¤ªã„ãƒãƒ„âœ•ï¼ˆç·šã§æç”»ï¼‰
          ctx.strokeStyle = 'white';
          ctx.lineWidth = size * 0.12;
          ctx.lineCap = 'round';
          ctx.beginPath();
          ctx.moveTo(size * 0.3, size * 0.3);
          ctx.lineTo(size * 0.7, size * 0.7);
          ctx.moveTo(size * 0.7, size * 0.3);
          ctx.lineTo(size * 0.3, size * 0.7);
          ctx.stroke();
        }
      }
    }

    /**
     * æ™‚é–“æ ãŒåˆå‰ã‹åˆå¾Œã‹ã‚’åˆ¤å®šï¼ˆ14æ™‚ã‚ˆã‚Šå‰ãŒåˆå‰ã€14æ™‚ä»¥é™ãŒåˆå¾Œï¼‰
     */
    function getTimeSlotPeriod(slot) {
      // "09:00" ã‚„ "15:30" ã®ã‚ˆã†ãªå½¢å¼ã‹ã‚‰æ™‚é–“ã‚’æŠ½å‡º
      const match = slot.match(/^(\d{1,2}):/);
      if (match) {
        const hour = parseInt(match[1], 10);
        return hour < 14 ? 'am' : 'pm';
      }
      return '';
    }

    /**
     * ã‚¹ãƒ­ãƒƒãƒˆã‚’åˆå‰/åˆå¾Œã«åˆ†é¡
     * åˆå‰: 15:00ã‚ˆã‚Šå‰
     * åˆå¾Œ: 15:00ä»¥é™
     */
    function splitSlots(slots) {
      if (!slots || slots.length === 0) {
        return { amSlots: [], pmSlots: [] };
      }

      const amSlots = slots.filter(slot => {
        const hour = parseInt(slot.split(':')[0], 10);
        return hour < 15;  // 15æ™‚ã‚ˆã‚Šå‰ = åˆå‰
      });
      const pmSlots = slots.filter(slot => {
        const hour = parseInt(slot.split(':')[0], 10);
        return hour >= 15; // 15æ™‚ä»¥é™ = åˆå¾Œ
      });
      return { amSlots, pmSlots };
    }

    /**
     * åˆå‰ã‚¹ãƒ­ãƒƒãƒˆã«13æ™‚ä»¥é™ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®š
     * @returns {boolean} 13æ™‚ä»¥é™ã®ã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚‹ã‹ã©ã†ã‹
     */
    function hasLateAmSlots(amSlots) {
      if (!amSlots || amSlots.length === 0) return false;
      return amSlots.some(slot => {
        const hour = parseInt(slot.split(':')[0], 10);
        return hour >= 13;
      });
    }

    /**
     * åˆå¾Œã‚¹ãƒ­ãƒƒãƒˆã«18:00ã‚ˆã‚Šå¾ŒãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®š
     * @returns {boolean} 18:00ã‚ˆã‚Šå¾Œã®ã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚‹ã‹ã©ã†ã‹
     */
    function hasLatePmSlots(pmSlots) {
      if (!pmSlots || pmSlots.length === 0) return false;
      return pmSlots.some(slot => {
        const match = slot.match(/^(\d{1,2}):(\d{2})/);
        if (match) {
          const hour = parseInt(match[1], 10);
          const minute = parseInt(match[2], 10);
          return hour > 18 || (hour === 18 && minute > 0);
        }
        return false;
      });
    }

    /**
     * åˆå‰ãƒãƒ¼ã®çµ‚äº†æ™‚åˆ»ã‚’æ±ºå®šï¼ˆåˆ†ï¼‰
     * é€šå¸¸: 13:00ï¼ˆ780åˆ†ï¼‰ã€13æ™‚ä»¥é™ã®äºˆç´„ãŒã‚ã‚Œã°14:00ï¼ˆ840åˆ†ï¼‰
     */
    function getAmEndMinutes(amSlots) {
      return hasLateAmSlots(amSlots) ? 14 * 60 : 13 * 60;
    }

    /**
     * åˆå¾Œãƒãƒ¼ã®çµ‚äº†æ™‚åˆ»ã‚’æ±ºå®šï¼ˆåˆ†ï¼‰
     * é€šå¸¸: 18:00ï¼ˆ1080åˆ†ï¼‰ã€18:00ä»¥é™ã®äºˆç´„ãŒã‚ã‚Œã°18:30ï¼ˆ1110åˆ†ï¼‰
     */
    function getPmEndMinutes(pmSlots) {
      return hasLatePmSlots(pmSlots) ? 18 * 60 + 30 : 18 * 60;
    }

    /**
     * æ™‚é–“æ–‡å­—åˆ—ã‚’åˆå‰ãƒãƒ¼ä¸Šã®ä½ç½®ï¼ˆ%ï¼‰ã«å¤‰æ›
     * åˆå‰ãƒãƒ¼: 10:00ã€œ13:00ï¼ˆé€šå¸¸ï¼‰ã¾ãŸã¯10:00ã€œ14:00ï¼ˆæ‹¡å¼µæ™‚ï¼‰
     */
    function timeToPositionAm(timeStr, endMinutes) {
      const match = timeStr.match(/^(\d{1,2}):(\d{2})/);
      if (!match) return null;

      const hour = parseInt(match[1], 10);
      const minute = parseInt(match[2], 10);
      const totalMinutes = hour * 60 + minute;

      const startMinutes = 10 * 60;  // 10:00
      const totalDuration = endMinutes - startMinutes;

      const position = ((totalMinutes - startMinutes) / totalDuration) * 100;

      if (position < 0 || position > 100) return null;
      return position;
    }

    /**
     * æ™‚é–“æ–‡å­—åˆ—ã‚’åˆå¾Œãƒãƒ¼ä¸Šã®ä½ç½®ï¼ˆ%ï¼‰ã«å¤‰æ›
     * åˆå¾Œãƒãƒ¼: 15:00ã€œ18:00ï¼ˆé€šå¸¸ï¼‰ã¾ãŸã¯15:00ã€œ18:30ï¼ˆæ‹¡å¼µæ™‚ï¼‰
     */
    function timeToPositionPm(timeStr, endMinutes) {
      const match = timeStr.match(/^(\d{1,2}):(\d{2})/);
      if (!match) return null;

      const hour = parseInt(match[1], 10);
      const minute = parseInt(match[2], 10);
      const totalMinutes = hour * 60 + minute;

      const startMinutes = 15 * 60;  // 15:00
      const totalDuration = endMinutes - startMinutes;

      const position = ((totalMinutes - startMinutes) / totalDuration) * 100;

      if (position < 0 || position > 100) return null;
      return position;
    }

    /**
     * åˆå‰ãƒãƒ¼ã®ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ï¼ˆ14æ™‚ã¾ã§æ‹¡å¼µã™ã‚‹ã‹ï¼‰
     */
    function updateAmLabels(type, extended) {
      const labelsElement = document.getElementById(`timeline-labels-${type}-am`);
      if (!labelsElement) return;

      if (extended) {
        labelsElement.innerHTML = `
          <span class="timeline-label">10</span>
          <span class="timeline-label">11</span>
          <span class="timeline-label">12</span>
          <span class="timeline-label">13</span>
          <span class="timeline-label">14</span>
        `;
      } else {
        labelsElement.innerHTML = `
          <span class="timeline-label">10</span>
          <span class="timeline-label">11</span>
          <span class="timeline-label">12</span>
          <span class="timeline-label">13</span>
        `;
      }
    }

    /**
     * åˆå¾Œãƒãƒ¼ã®ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ï¼ˆ18:30ã¾ã§æ‹¡å¼µã™ã‚‹ã‹ï¼‰
     */
    function updatePmLabels(type, extended) {
      const labelsElement = document.getElementById(`timeline-labels-${type}-pm`);
      if (!labelsElement) return;

      if (extended) {
        labelsElement.innerHTML = `
          <span class="timeline-label">15</span>
          <span class="timeline-label">16</span>
          <span class="timeline-label">17</span>
          <span class="timeline-label">18</span>
          <span class="timeline-label" style="font-size: 10px;">:30</span>
        `;
      } else {
        labelsElement.innerHTML = `
          <span class="timeline-label">15</span>
          <span class="timeline-label">16</span>
          <span class="timeline-label">17</span>
          <span class="timeline-label">18</span>
        `;
      }
    }

    // 15åˆ†åˆ»ã¿ã®æ™‚é–“å¸¯å®šç¾©
    const AM_SLOTS = ['10:00', '10:15', '10:30', '10:45', '11:00', '11:15', '11:30', '11:45', '12:00', '12:15', '12:30', '12:45', '13:00'];
    const PM_SLOTS = ['15:00', '15:15', '15:30', '15:45', '16:00', '16:15', '16:30', '16:45', '17:00', '17:15', '17:30', '17:45', '18:00'];

    /**
     * ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒãƒ¼ï¼ˆã‚»ãƒ«ãƒãƒ¼å½¢å¼ï¼šåˆå‰/åˆå¾Œï¼‰ã‚’æç”»
     * @param {string} type - 'general' ã¾ãŸã¯ 'shiya'
     * @param {string[]} slots - ç©ºãæ™‚é–“æ ã®é…åˆ—ï¼ˆä¾‹: ["10:00", "11:30", "15:00"]ï¼‰
     * @param {string} themeColor - ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼ˆæœªä½¿ç”¨ã€CSSã§å®šç¾©ï¼‰
     */
    function renderTimeline(type, slots, themeColor) {
      const amBarElement = document.getElementById(`timeline-bar-${type}-am`);
      const pmBarElement = document.getElementById(`timeline-bar-${type}-pm`);
      if (!amBarElement || !pmBarElement) return;

      // æ—¢å­˜ã®ã‚»ãƒ«ã‚’å‰Šé™¤
      amBarElement.innerHTML = '';
      pmBarElement.innerHTML = '';

      // åˆå‰ãƒãƒ¼ã«ã‚»ãƒ«ã‚’è¿½åŠ 
      AM_SLOTS.forEach(slot => {
        const cell = document.createElement('div');
        cell.className = `timeline-cell ${type}`;
        const isAvailable = slots.includes(slot);
        cell.classList.add(isAvailable ? 'available' : 'filled');
        cell.title = slot + (isAvailable ? ' (ç©ºã)' : ' (åŸ‹ã¾ã‚Š)');
        amBarElement.appendChild(cell);
      });

      // åˆå¾Œãƒãƒ¼ã«ã‚»ãƒ«ã‚’è¿½åŠ 
      PM_SLOTS.forEach(slot => {
        const cell = document.createElement('div');
        cell.className = `timeline-cell ${type}`;
        const isAvailable = slots.includes(slot);
        cell.classList.add(isAvailable ? 'available' : 'filled');
        cell.title = slot + (isAvailable ? ' (ç©ºã)' : ' (åŸ‹ã¾ã‚Š)');
        pmBarElement.appendChild(cell);
      });
    }

    /**
     * æ™‚é–“æ ãƒªã‚¹ãƒˆã‚’HTMLã§ç”Ÿæˆï¼ˆå…¨ã¦è¡¨ç¤ºã€AM/PMè‰²åˆ†ã‘ï¼‰
     */
    function renderTimeslots(type, slots, slotsCount) {
      const listElement = document.getElementById(`timeslots-list-${type}`);
      const expandIndicator = document.getElementById(`expand-${type}`);
      const containerElement = document.getElementById(`timeslots-${type}`);

      // ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      slotsData[type] = slots;

      if (slotsCount > 0 && slots.length > 0) {
        // å…¨ã¦ã®æ™‚é–“æ ã‚’è¡¨ç¤ºï¼ˆAM/PMè‰²åˆ†ã‘ï¼‰
        const html = slots.map(slot => {
          const period = getTimeSlotPeriod(slot);
          return `
            <div class="timeslot-item ${period}">
              <span>${slot}</span>
            </div>
          `;
        }).join('');

        listElement.innerHTML = html;
        expandIndicator.style.display = 'block';
        containerElement.style.display = 'block';

        // 8æ ä»¥ä¸Šã®ã¨ãã¯6åˆ—è¡¨ç¤ºï¼ˆmany-slotsã‚¯ãƒ©ã‚¹è¿½åŠ ï¼‰
        if (slotsCount >= 8) {
          listElement.classList.add('many-slots');
        } else {
          listElement.classList.remove('many-slots');
        }
      } else {
        // æ™‚é–“æ ãŒãªã„å ´åˆã¯ã‚³ãƒ³ãƒ†ãƒŠã”ã¨éè¡¨ç¤º
        listElement.innerHTML = '';
        expandIndicator.style.display = 'none';
        containerElement.style.display = 'none';
      }
    }

    /**
     * Cloud Storageã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
     */
    async function fetchTimeslotsData(url) {
      try {
        const response = await fetch(url + '?t=' + Date.now()); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }

    /**
     * æ—¥ä»˜ã‹ã‚‰é©åˆ‡ãªè¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’è¨ˆç®—ï¼ˆæœˆ/æ—¥å½¢å¼ï¼‰
     */
    function calculateDisplayTextWithDate(targetDate) {
      if (!targetDate) {
        return 'æœ¬æ—¥';
      }

      const now = new Date();
      const currentDate = now.getDate();
      const currentMonth = now.getMonth() + 1;

      // å¯¾è±¡æ—¥ãŒä»Šæœˆã‹æ¥æœˆã‹ã‚’åˆ¤å®š
      let targetMonth = currentMonth;
      if (targetDate < currentDate) {
        // æ—¥ä»˜ãŒå°ã•ã„å ´åˆã¯æ¥æœˆã¨åˆ¤æ–­
        targetMonth = currentMonth === 12 ? 1 : currentMonth + 1;
      }

      // æœ¬æ—¥/æ˜æ—¥/æ¬¡ã®è¨ºç™‚æ—¥ã‚’åˆ¤å®š
      let displayText;
      if (targetDate === currentDate) {
        displayText = 'æœ¬æ—¥';
      } else if (targetDate === currentDate + 1) {
        displayText = 'æ˜æ—¥';
      } else {
        displayText = 'æ¬¡ã®è¨ºç™‚æ—¥';
      }

      return `${displayText}ï¼ˆ${targetMonth}/${targetDate}ï¼‰`;
    }

    /**
     * ä¸¡æ–¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
     */
    async function updateAll() {
      const btn = document.getElementById('refresh-btn');
      btn.disabled = true;
      btn.innerHTML = 'æ›´æ–°ä¸­<span class="loading"></span>';

      try {
        // ä¸€èˆ¬äºˆç´„
        const generalData = await fetchTimeslotsData(TIMESLOTS_URLS.general);
        if (generalData) {
          const slotsCount = generalData.slots ? generalData.slots.length : 0;
          const displayText = calculateDisplayTextWithDate(generalData.date);

          drawIcon('canvas-general', slotsCount, generalData.status, '#CC6600', 'ä¸€');

          if (slotsCount > 0) {
            document.getElementById('status-general').textContent = `æ®‹ã‚Š${slotsCount}æ `;
            document.getElementById('status-general').className = 'status available';
          } else {
            document.getElementById('status-general').textContent = 'âœ• æº€æ ';
            document.getElementById('status-general').className = 'status full';
          }

          document.getElementById('day-text-general').textContent = displayText;
          renderTimeslots('general', generalData.slots || [], slotsCount);
          renderTimeline('general', generalData.slots || [], '#CC6600');
        } else {
          document.getElementById('status-general').textContent = 'ã‚¨ãƒ©ãƒ¼';
          document.getElementById('status-general').className = 'status error';
          document.getElementById('day-text-general').textContent = '';
          renderTimeline('general', [], '#CC6600');
        }

        // è¦–é‡äºˆç´„
        const shiyaData = await fetchTimeslotsData(TIMESLOTS_URLS.shiya);
        if (shiyaData) {
          const slotsCount = shiyaData.slots ? shiyaData.slots.length : 0;
          const displayText = calculateDisplayTextWithDate(shiyaData.date);

          drawIcon('canvas-shiya', slotsCount, shiyaData.status, '#006633', 'è¦–');

          if (slotsCount > 0) {
            document.getElementById('status-shiya').textContent = `æ®‹ã‚Š${slotsCount}æ `;
            document.getElementById('status-shiya').className = 'status available';
          } else {
            document.getElementById('status-shiya').textContent = 'âœ• æº€æ ';
            document.getElementById('status-shiya').className = 'status full';
          }

          document.getElementById('day-text-shiya').textContent = displayText;
          renderTimeslots('shiya', shiyaData.slots || [], slotsCount);
          renderTimeline('shiya', shiyaData.slots || [], '#006633');
        } else {
          document.getElementById('status-shiya').textContent = 'ã‚¨ãƒ©ãƒ¼';
          document.getElementById('status-shiya').className = 'status error';
          document.getElementById('day-text-shiya').textContent = '';
          renderTimeline('shiya', [], '#006633');
        }

        // æ›´æ–°æ™‚åˆ»
        const now = new Date();
        const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('update-time').textContent = `æœ€çµ‚æ›´æ–°: ${timeStr}`;

      } catch (error) {
        console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ æ›´æ–°';
      }
    }

    // æ›´æ–°ãƒœã‚¿ãƒ³
    document.getElementById('refresh-btn').addEventListener('click', updateAll);

    // åˆå›èª­ã¿è¾¼ã¿
    updateAll();

    // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
    setInterval(updateAll, 30000);
  </script>
</body>
</html>
