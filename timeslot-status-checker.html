<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äºˆç´„çŠ¶æ³ãƒã‚§ãƒƒã‚«ãƒ¼ï¼ˆæ™‚é–“æ å¯¾å¿œï¼‰</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 700px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 15px 15px;
    }

    .cards {
      display: flex;
      flex-direction: row;
      gap: 12px;
      margin-bottom: 15px;
    }

    .card {
      flex: 1;
      background: #f8f9fa;
      border-radius: 15px;
      padding: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .card.general {
      background: #fff8f0;
    }

    .card.shiya {
      background: #f0fff4;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-wrapper {
      flex-shrink: 0;
    }

    canvas {
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .card-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      color: #666;
      margin-bottom: 4px;
    }

    .card-title.general {
      color: #CC6600;
    }

    .card-title.shiya {
      color: #006633;
    }

    .status {
      font-size: 20px;
      font-weight: 700;
    }

    .status.available {
      color: #27ae60;
    }

    .status.full {
      color: #dc3545;
    }

    .status.error {
      color: #999;
    }

    .day-text {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-top: 4px;
    }

    /* çµ±åˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å½¢å¼ï¼‰ */
    .combined-timeline {
      margin: 15px 0;
      overflow-x: auto;
    }

    .combined-timeline table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      min-width: 500px;
    }

    .combined-timeline th,
    .combined-timeline td {
      text-align: center;
      border: 1px solid #e0e0e0;
      padding: 0;
    }

    /* æ™‚é–“ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ */
    .combined-timeline .hour-row th {
      font-size: 16px;
      font-weight: 700;
      padding: 4px 0;
      border-bottom: none;
    }

    .combined-timeline .hour-row th.am-header {
      background: #fff3e0;
    }

    .combined-timeline .hour-row th.pm-header {
      background: #e3f2fd;
    }

    .combined-timeline .hour-row th.label-header {
      background: #f5f5f5;
      width: 40px;
      font-size: 12px;
    }

    /* åˆ†ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ */
    .combined-timeline .minute-row th {
      font-size: 12px;
      font-weight: 500;
      padding: 3px 0;
      border-top: none;
    }

    .combined-timeline .minute-row th.am-minute {
      background: #fff3e0;
    }

    .combined-timeline .minute-row th.am-minute.hour-start {
      background: #ffe0b2;
    }

    .combined-timeline .minute-row th.pm-minute {
      background: #e3f2fd;
    }

    .combined-timeline .minute-row th.pm-minute.hour-start {
      background: #bbdefb;
    }

    .combined-timeline .minute-row th.label-header {
      background: #f5f5f5;
      width: 40px;
    }

    /* ã‚»ãƒ«è¡Œ */
    .combined-timeline .cell-row td {
      height: 32px;
    }

    .combined-timeline .cell-row td.hour-start {
      border-left: 2px solid #999;
    }

    .combined-timeline .cell-row td.row-label {
      background: #f5f5f5;
      font-size: 13px;
      font-weight: 700;
      width: 40px;
    }

    .combined-timeline .cell-row td.row-label.general {
      color: #CC6600;
    }

    .combined-timeline .cell-row td.row-label.shiya {
      color: #006633;
    }

    /* ã‚»ãƒ«ã®çŠ¶æ…‹ */
    .combined-timeline .cell-available {
      background: white;
    }

    .combined-timeline .cell-filled.general {
      background: #CC6600;
    }

    .combined-timeline .cell-filled.shiya {
      background: #006633;
    }

    .footer {
      text-align: center;
      margin-top: 10px;
    }

    .update-time {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .footer-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .dashboard-btn {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .dashboard-btn:active {
      transform: scale(0.95);
      background: #f0f0ff;
    }

    .refresh-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s;
    }

    .refresh-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .refresh-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-left: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* å£æ›ã‘ãƒ¢ãƒ¼ãƒ‰: 801pxä»¥ä¸Šï¼ˆvwå˜ä½ã§è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰ */
    @media (min-width: 801px) {
      .container {
        max-width: 98vw;
        padding: 1.5vw;
      }

      .cards {
        gap: 2vw;
        margin-bottom: 1.5vw;
      }

      .card {
        padding: 1.5vw;
        border-radius: 1.5vw;
      }

      .card-header {
        gap: 1.5vw;
      }

      canvas {
        width: 12vw !important;
        height: 12vw !important;
        min-width: 100px;
        min-height: 100px;
      }

      .card-title {
        font-size: 2.5vw;
        margin-bottom: 0.5vw;
      }

      .status {
        font-size: 4vw;
      }

      .day-text {
        font-size: 2vw;
        margin-top: 0.5vw;
      }

      /* çµ±åˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - å¤§ç”»é¢ */
      .combined-timeline {
        margin: 1.5vw 0;
      }

      .combined-timeline table {
        min-width: auto;
      }

      .combined-timeline .hour-row th {
        font-size: 2vw;
        padding: 0.5vw 0;
      }

      .combined-timeline .hour-row th.label-header {
        width: 4vw;
        font-size: 1.5vw;
      }

      .combined-timeline .minute-row th {
        font-size: 1.5vw;
        padding: 0.4vw 0;
      }

      .combined-timeline .minute-row th.label-header {
        width: 4vw;
      }

      .combined-timeline .cell-row td {
        height: 4vw;
      }

      .combined-timeline .cell-row td.row-label {
        width: 4vw;
        font-size: 1.8vw;
      }

      /* ãƒ•ãƒƒã‚¿ãƒ¼ - å¤§ç”»é¢ */
      .footer {
        margin-top: 1vw;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1.5vw;
        background: #f5f5f5;
        padding: 0.8vw 1.5vw;
        border-radius: 1vw;
      }

      .update-time {
        font-size: 1.8vw;
        margin-bottom: 0;
      }

      .refresh-btn {
        padding: 0.6vw 2vw;
        font-size: 1.4vw;
        border-radius: 1.5vw;
      }

      .dashboard-btn {
        padding: 0.6vw 1.5vw;
        font-size: 1.4vw;
        border-radius: 1.5vw;
        border-width: 0.2vw;
      }

      .footer-buttons {
        gap: 1vw;
      }
    }

    /* ã‚¹ãƒãƒ›ãƒ¢ãƒ¼ãƒ‰: 800pxä»¥ä¸‹ */
    @media (max-width: 800px) {
      body {
        padding: 8px;
      }

      .container {
        padding: 10px;
      }

      .cards {
        gap: 8px;
        margin-bottom: 12px;
      }

      .card {
        padding: 10px;
        border-radius: 12px;
      }

      canvas {
        width: 64px !important;
        height: 64px !important;
      }

      .card-title {
        font-size: 14px;
      }

      .status {
        font-size: 18px;
      }

      .day-text {
        font-size: 12px;
      }

      /* çµ±åˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - ã‚¹ãƒãƒ› */
      .combined-timeline {
        margin: 10px -5px;
      }

      .combined-timeline .hour-row th {
        font-size: 14px;
        padding: 3px 0;
      }

      .combined-timeline .hour-row th.label-header {
        width: 32px;
        font-size: 10px;
      }

      .combined-timeline .minute-row th {
        font-size: 10px;
        padding: 2px 0;
      }

      .combined-timeline .minute-row th.label-header {
        width: 32px;
      }

      .combined-timeline .cell-row td {
        height: 28px;
      }

      .combined-timeline .cell-row td.row-label {
        width: 32px;
        font-size: 11px;
      }
    }

    /* è¶…å°å‹ã‚¹ãƒãƒ›: 400pxä»¥ä¸‹ */
    @media (max-width: 400px) {
      .combined-timeline .hour-row th {
        font-size: 12px;
      }

      .combined-timeline .minute-row th {
        font-size: 9px;
      }

      .combined-timeline .cell-row td {
        height: 24px;
      }

      .combined-timeline .cell-row td.row-label {
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ç‰¹å¤§ã‚¢ã‚¤ã‚³ãƒ³ã‚«ãƒ¼ãƒ‰ -->
    <div class="cards">
      <!-- ä¸€èˆ¬äºˆç´„ -->
      <div class="card general">
        <div class="card-header">
          <div class="icon-wrapper">
            <canvas id="canvas-general" width="128" height="128"></canvas>
          </div>
          <div class="card-info">
            <div class="card-title general">ä¸€èˆ¬äºˆç´„</div>
            <div id="status-general" class="status">èª­ã¿è¾¼ã¿ä¸­...</div>
            <div id="day-text-general" class="day-text"></div>
          </div>
        </div>
      </div>

      <!-- è¦–é‡äºˆç´„ -->
      <div class="card shiya">
        <div class="card-header">
          <div class="icon-wrapper">
            <canvas id="canvas-shiya" width="128" height="128"></canvas>
          </div>
          <div class="card-info">
            <div class="card-title shiya">è¦–é‡äºˆç´„</div>
            <div id="status-shiya" class="status">èª­ã¿è¾¼ã¿ä¸­...</div>
            <div id="day-text-shiya" class="day-text"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- çµ±åˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
    <div class="combined-timeline" id="combinedTimeline">
      <!-- JSã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <div class="footer">
      <div id="update-time" class="update-time">æ›´æ–°ä¸­...</div>
      <div class="footer-buttons">
        <a href="dashboard.html" class="dashboard-btn">ğŸ“Š è§£æ</a>
        <button id="refresh-btn" class="refresh-btn">ğŸ”„ æ›´æ–°</button>
      </div>
    </div>
  </div>

  <script>
    // Cloud Storageã®URL
    const TIMESLOTS_URLS = {
      general: 'https://storage.googleapis.com/reservation-timeslots-fujiminohikari/timeslots.json',
      shiya: 'https://storage.googleapis.com/reservation-timeslots-fujiminohikari/timeslots-shiya.json'
    };

    // ç¾åœ¨ã®ç©ºãæ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    const currentSlotsData = {
      general: [],
      shiya: []
    };

    /**
     * Canvas APIã§ã‚¢ã‚¤ã‚³ãƒ³ã‚’æç”»ï¼ˆæ æ•°ã‚’æ•°å­—ã§è¡¨ç¤ºï¼‰
     */
    function drawIcon(canvasId, slotsCount, status, themeColor, text) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      const size = 128;
      const cellSize = size / 2;
      const borderRadius = size * 0.15;

      // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
      ctx.clearRect(0, 0, size, size);

      // æ æ•° > 0 ã®å ´åˆã¯ç™½èƒŒæ™¯+è‰²æ +ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼æ•°å­—ã®ãƒ‡ã‚¶ã‚¤ãƒ³
      if (status !== 'error' && slotsCount > 0) {
        const borderWidth = Math.max(1, Math.round(size * 0.08));

        // ç™½èƒŒæ™¯ã§å¡—ã‚Šã¤ã¶ã—
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, size, size);

        // å¤–æ ã‚’æç”»
        ctx.strokeStyle = themeColor;
        ctx.lineWidth = borderWidth;
        ctx.strokeRect(borderWidth / 2, borderWidth / 2, size - borderWidth, size - borderWidth);

        // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã®å¤ªã„æ•°å­—ã‚’æœ€å¤§ã‚µã‚¤ã‚ºã§è¡¨ç¤º
        ctx.fillStyle = themeColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const fontSize = slotsCount >= 10 ? size * 0.8 : size * 0.95;
        ctx.font = `bold ${fontSize}px sans-serif`;
        ctx.fillText(slotsCount.toString(), size / 2, size / 2);
      } else {
        // æ æ•° = 0 ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ—¢å­˜ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆ2Ã—2ã‚°ãƒªãƒƒãƒ‰ï¼‰
        let bgColor;
        if (status === 'error') {
          bgColor = '#FFA500';
        } else {
          bgColor = '#dc3545';
        }

        // å·¦ä¸Š3ãƒã‚¹ï¼ˆäºˆç´„çŠ¶æ³ï¼‰
        ctx.fillStyle = bgColor;

        // å·¦ä¸Š
        ctx.beginPath();
        ctx.moveTo(borderRadius, 0);
        ctx.lineTo(cellSize, 0);
        ctx.lineTo(cellSize, cellSize);
        ctx.lineTo(0, cellSize);
        ctx.lineTo(0, borderRadius);
        ctx.arcTo(0, 0, borderRadius, 0, borderRadius);
        ctx.closePath();
        ctx.fill();

        // å³ä¸Š
        ctx.beginPath();
        ctx.moveTo(cellSize, 0);
        ctx.lineTo(size - borderRadius, 0);
        ctx.arcTo(size, 0, size, borderRadius, borderRadius);
        ctx.lineTo(size, cellSize);
        ctx.lineTo(cellSize, cellSize);
        ctx.closePath();
        ctx.fill();

        // å·¦ä¸‹
        ctx.beginPath();
        ctx.moveTo(0, cellSize);
        ctx.lineTo(cellSize, cellSize);
        ctx.lineTo(cellSize, size);
        ctx.lineTo(borderRadius, size);
        ctx.arcTo(0, size, 0, size - borderRadius, borderRadius);
        ctx.lineTo(0, cellSize);
        ctx.closePath();
        ctx.fill();

        // å³ä¸‹1ãƒã‚¹ï¼ˆãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼+æ–‡å­—ï¼‰
        ctx.fillStyle = themeColor;
        ctx.beginPath();
        ctx.moveTo(cellSize, cellSize);
        ctx.lineTo(size, cellSize);
        ctx.lineTo(size, size - borderRadius);
        ctx.arcTo(size, size, size - borderRadius, size, borderRadius);
        ctx.lineTo(cellSize, size);
        ctx.lineTo(cellSize, cellSize);
        ctx.closePath();
        ctx.fill();

        // ç™½æ–‡å­—ã‚’å³ä¸‹ãƒã‚¹ã«æç”»
        ctx.fillStyle = 'white';
        ctx.font = `bold ${cellSize * 0.7}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, cellSize + cellSize / 2, cellSize + cellSize / 2);

        // ä¸­å¤®ã«ãƒãƒ¼ã‚¯ã‚’æç”»
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        if (status === 'error') {
          ctx.fillStyle = 'white';
          ctx.font = `bold ${size * 0.6}px sans-serif`;
          ctx.fillText('âš ', size / 2, size / 2);
        } else {
          // æº€æ ï¼šå¤ªã„ãƒãƒ„âœ•
          ctx.strokeStyle = 'white';
          ctx.lineWidth = size * 0.12;
          ctx.lineCap = 'round';
          ctx.beginPath();
          ctx.moveTo(size * 0.3, size * 0.3);
          ctx.lineTo(size * 0.7, size * 0.7);
          ctx.moveTo(size * 0.7, size * 0.3);
          ctx.lineTo(size * 0.3, size * 0.7);
          ctx.stroke();
        }
      }
    }

    /**
     * ã‚¹ãƒ­ãƒƒãƒˆãŒç©ºãã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
     * å½“é™¢ãƒ«ãƒ¼ãƒ«: 13:00ã¯12:55ã‚’ã€18:00ã¯17:55ã‚’ãƒã‚§ãƒƒã‚¯
     */
    function isSlotAvailable(slot, availableSlots) {
      if (slot === '13:00') {
        return availableSlots.includes('12:55') || availableSlots.includes('13:00');
      }
      if (slot === '18:00') {
        return availableSlots.includes('17:55') || availableSlots.includes('18:00');
      }
      return availableSlots.includes(slot);
    }

    /**
     * çµ±åˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æç”»ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å½¢å¼ï¼‰
     */
    function renderCombinedTimeline() {
      const container = document.getElementById('combinedTimeline');
      if (!container) return;

      const generalSlots = currentSlotsData.general || [];
      const shiyaSlots = currentSlotsData.shiya || [];

      // æ™‚é–“ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å®šç¾©
      const hourGroups = [
        { hour: 10, slots: ['10:00', '10:15', '10:30', '10:45'], isAm: true },
        { hour: 11, slots: ['11:00', '11:15', '11:30', '11:45'], isAm: true },
        { hour: 12, slots: ['12:00', '12:15', '12:30', '12:45', '13:00'], isAm: true },
        { hour: 15, slots: ['15:00', '15:15', '15:30', '15:45'], isAm: false },
        { hour: 16, slots: ['16:00', '16:15', '16:30', '16:45'], isAm: false },
        { hour: 17, slots: ['17:00', '17:15', '17:30', '17:45', '18:00'], isAm: false }
      ];

      let html = '<table>';

      // æ™‚é–“ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
      html += '<tr class="hour-row">';
      html += '<th class="label-header"></th>';
      hourGroups.forEach(group => {
        const headerClass = group.isAm ? 'am-header' : 'pm-header';
        html += `<th colspan="${group.slots.length}" class="${headerClass}">${group.hour}</th>`;
      });
      html += '</tr>';

      // åˆ†ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
      html += '<tr class="minute-row">';
      html += '<th class="label-header"></th>';
      hourGroups.forEach(group => {
        group.slots.forEach(slot => {
          const minute = slot.split(':')[1];
          const baseClass = group.isAm ? 'am-minute' : 'pm-minute';
          const hourStartClass = (minute === '00' && slot !== '13:00' && slot !== '18:00') ? ' hour-start' : '';
          const displayMinute = (slot === '13:00' || slot === '18:00') ? '55' : minute;
          html += `<th class="${baseClass}${hourStartClass}">${displayMinute}</th>`;
        });
      });
      html += '</tr>';

      // ä¸€èˆ¬äºˆç´„ã‚»ãƒ«è¡Œ
      html += '<tr class="cell-row">';
      html += '<td class="row-label general">ä¸€èˆ¬</td>';
      hourGroups.forEach(group => {
        group.slots.forEach(slot => {
          const isAvailable = isSlotAvailable(slot, generalSlots);
          const minute = slot.split(':')[1];
          const hourStartClass = (minute === '00' && slot !== '13:00' && slot !== '18:00') ? ' hour-start' : '';

          let cellClass = isAvailable ? 'cell-available' : 'cell-filled general';

          let displaySlot = slot;
          if (slot === '13:00') displaySlot = '12:55';
          if (slot === '18:00') displaySlot = '17:55';

          const tooltip = isAvailable ? `${displaySlot} ç©ºã` : `${displaySlot} åŸ‹ã¾ã‚Š`;

          html += `<td class="${cellClass}${hourStartClass}" title="${tooltip}"></td>`;
        });
      });
      html += '</tr>';

      // è¦–é‡äºˆç´„ã‚»ãƒ«è¡Œ
      html += '<tr class="cell-row">';
      html += '<td class="row-label shiya">è¦–é‡</td>';
      hourGroups.forEach(group => {
        group.slots.forEach(slot => {
          const isAvailable = isSlotAvailable(slot, shiyaSlots);
          const minute = slot.split(':')[1];
          const hourStartClass = (minute === '00' && slot !== '13:00' && slot !== '18:00') ? ' hour-start' : '';

          let cellClass = isAvailable ? 'cell-available' : 'cell-filled shiya';

          let displaySlot = slot;
          if (slot === '13:00') displaySlot = '12:55';
          if (slot === '18:00') displaySlot = '17:55';

          const tooltip = isAvailable ? `${displaySlot} ç©ºã` : `${displaySlot} åŸ‹ã¾ã‚Š`;

          html += `<td class="${cellClass}${hourStartClass}" title="${tooltip}"></td>`;
        });
      });
      html += '</tr>';

      html += '</table>';
      container.innerHTML = html;
    }

    /**
     * Cloud Storageã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
     */
    async function fetchTimeslotsData(url) {
      try {
        const response = await fetch(url + '?t=' + Date.now());
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }

    /**
     * æ—¥ä»˜ã‹ã‚‰é©åˆ‡ãªè¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’è¨ˆç®—
     */
    function calculateDisplayTextWithDate(targetDate) {
      if (!targetDate) {
        return 'æœ¬æ—¥';
      }

      const now = new Date();
      const currentDate = now.getDate();
      const currentMonth = now.getMonth() + 1;

      let targetMonth = currentMonth;
      if (targetDate < currentDate) {
        targetMonth = currentMonth === 12 ? 1 : currentMonth + 1;
      }

      let displayText;
      if (targetDate === currentDate) {
        displayText = 'æœ¬æ—¥';
      } else if (targetDate === currentDate + 1) {
        displayText = 'æ˜æ—¥';
      } else {
        displayText = 'æ¬¡ã®è¨ºç™‚æ—¥';
      }

      return `${displayText}ï¼ˆ${targetMonth}/${targetDate}ï¼‰`;
    }

    /**
     * ä¸¡æ–¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
     */
    async function updateAll() {
      const btn = document.getElementById('refresh-btn');
      btn.disabled = true;
      btn.innerHTML = 'æ›´æ–°ä¸­<span class="loading"></span>';

      try {
        // ä¸€èˆ¬äºˆç´„
        const generalData = await fetchTimeslotsData(TIMESLOTS_URLS.general);
        if (generalData) {
          const slotsCount = generalData.slots ? generalData.slots.length : 0;
          const displayText = calculateDisplayTextWithDate(generalData.date);

          drawIcon('canvas-general', slotsCount, generalData.status, '#CC6600', 'ä¸€');

          if (slotsCount > 0) {
            document.getElementById('status-general').textContent = `æ®‹ã‚Š${slotsCount}æ `;
            document.getElementById('status-general').className = 'status available';
          } else {
            document.getElementById('status-general').textContent = 'âœ• æº€æ ';
            document.getElementById('status-general').className = 'status full';
          }

          document.getElementById('day-text-general').textContent = displayText;
          currentSlotsData.general = generalData.slots || [];
        } else {
          document.getElementById('status-general').textContent = 'ã‚¨ãƒ©ãƒ¼';
          document.getElementById('status-general').className = 'status error';
          document.getElementById('day-text-general').textContent = '';
          currentSlotsData.general = [];
        }

        // è¦–é‡äºˆç´„
        const shiyaData = await fetchTimeslotsData(TIMESLOTS_URLS.shiya);
        if (shiyaData) {
          const slotsCount = shiyaData.slots ? shiyaData.slots.length : 0;
          const displayText = calculateDisplayTextWithDate(shiyaData.date);

          drawIcon('canvas-shiya', slotsCount, shiyaData.status, '#006633', 'è¦–');

          if (slotsCount > 0) {
            document.getElementById('status-shiya').textContent = `æ®‹ã‚Š${slotsCount}æ `;
            document.getElementById('status-shiya').className = 'status available';
          } else {
            document.getElementById('status-shiya').textContent = 'âœ• æº€æ ';
            document.getElementById('status-shiya').className = 'status full';
          }

          document.getElementById('day-text-shiya').textContent = displayText;
          currentSlotsData.shiya = shiyaData.slots || [];
        } else {
          document.getElementById('status-shiya').textContent = 'ã‚¨ãƒ©ãƒ¼';
          document.getElementById('status-shiya').className = 'status error';
          document.getElementById('day-text-shiya').textContent = '';
          currentSlotsData.shiya = [];
        }

        // çµ±åˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æç”»
        renderCombinedTimeline();

        // æ›´æ–°æ™‚åˆ»
        const now = new Date();
        const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('update-time').textContent = `æœ€çµ‚æ›´æ–°: ${timeStr}`;

      } catch (error) {
        console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ æ›´æ–°';
      }
    }

    // æ›´æ–°ãƒœã‚¿ãƒ³
    document.getElementById('refresh-btn').addEventListener('click', updateAll);

    // åˆå›èª­ã¿è¾¼ã¿
    updateAll();

    // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
    setInterval(updateAll, 30000);
  </script>
</body>
</html>
